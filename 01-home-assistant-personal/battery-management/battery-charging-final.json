[
    {
        "id": "battery_complete_tab",
        "type": "tab",
        "label": "æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - æœ€çµ‚ç‰ˆ",
        "disabled": false,
        "info": "å®Œæ•´çš„æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - æœ€çµ‚ä¿®æ­£ç‰ˆ\n\nä¿®æ­£å…§å®¹ï¼š\n1. ç‰§ç”°é›»æ± domainæ”¹ç‚ºswitch\n2. è¨­å‚™æ§åˆ¶ç¯€é»æ­£ç¢ºé…ç½®\n3. ä¿®æ­£é€šçŸ¥æœå‹™é…ç½®\n4. åŠ å›ç¶­è­·æª¢æŸ¥å’Œç‹€æ…‹å ±å‘ŠåŠŸèƒ½\n5. å®Œæ•´çš„debugè¼¸å‡º\n\nåŠŸèƒ½ï¼š\n1. æ‰‹å‹•å……é›»è‡ªå‹•è¨ˆæ™‚é—œé–‰\n2. ä¸‰å€‹ç¨ç«‹çš„é€šçŸ¥æœå‹™\n3. ç¶­è­·å……é›»æª¢æŸ¥\n4. ç³»çµ±ç‹€æ…‹å ±å‘Š\n5. å®Œæ•´çš„debugè¼¸å‡º\n\næ”¯æ´è¨­å‚™ï¼š\n- ç‰§ç”°BL1041B (switch.tp_link_power_strip_eb2f_cha_shang_4)\n- ENELOOP 3è™Ÿ (switch.tp_link_power_strip_eb2f_cha_shang_5)\n- ENELOOP 4è™Ÿ (switch.tp_link_power_strip_eb2f_cha_shang_6)\n\né€šçŸ¥æœå‹™ï¼š\n- NotifyHelper (notify.notify)\n- Synology Chat (notify.synology_chat_bot_3)\n- Telegram (notify.telegram)",
        "env": []
    },
    {
        "id": "init_system",
        "type": "inject",
        "z": "battery_complete_tab",
        "name": "ç³»çµ±åˆå§‹åŒ–",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 3,
        "topic": "",
        "payload": "initialize",
        "payloadType": "str",
        "x": 120,
        "y": 60,
        "wires": [["setup_config"]]
    },
    {
        "id": "setup_config",
        "type": "function",
        "z": "battery_complete_tab",
        "name": "è¼‰å…¥é…ç½®",
        "func": "// é›»æ± é…ç½® - æœ€çµ‚ä¿®æ­£ç‰ˆ\nconst batteries = {\n    makita: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_4',\n        name: 'ç‰§ç”°BL1041Bå……é›»é›»æ± ',\n        chargingTime: 90,\n        maintenanceDays: 30,\n        domain: 'switch'\n    },\n    eneloop_aa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_5',\n        name: 'ENELOOP 3è™Ÿå……é›»é›»æ± ',\n        chargingTime: 240,\n        maintenanceDays: 60,\n        domain: 'switch'\n    },\n    eneloop_aaa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_6',\n        name: 'ENELOOP 4è™Ÿå……é›»é›»æ± ',\n        chargingTime: 210,\n        maintenanceDays: 60,\n        domain: 'switch'\n    }\n};\n\n// é€šçŸ¥æœå‹™é…ç½®\nconst notifications = {\n    services: ['notify.notify', 'notify.synology_chat_bot_3', 'notify.telegram'],\n    enabled: true,\n    quietHours: { start: 22, end: 7 }\n};\n\n// å„²å­˜é…ç½®\nflow.set('batteries', batteries);\nflow.set('notifications', notifications);\n\n// åˆå§‹åŒ–å……é›»è¨˜éŒ„\nconst records = flow.get('chargingRecords') || {};\nObject.keys(batteries).forEach(key => {\n    if (!records[key]) {\n        records[key] = {\n            lastCharge: null,\n            count: 0\n        };\n    }\n});\nflow.set('chargingRecords', records);\n\nmsg.payload = {\n    status: 'initialized',\n    batteries: Object.keys(batteries).length,\n    notifications: notifications.services.length,\n    timestamp: new Date().toISOString(),\n    config: batteries\n};\n\nnode.status({fill:\"green\", shape:\"dot\", text:\"ç³»çµ±å·²åˆå§‹åŒ–\"});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 60,
        "wires": [["debug_init"]]
    },
    {
        "id": "debug_init",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "åˆå§‹åŒ–Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 500,
        "y": 60,
        "wires": []
    },
    {
        "id": "makita_state",
        "type": "server-state-changed",
        "z": "battery_complete_tab",
        "name": "ç‰§ç”°é›»æ± ç‹€æ…‹",
        "server": "125d83f7.1a33dc",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": ["switch.tp_link_power_strip_eb2f_cha_shang_4"],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            }
        ],
        "x": 120,
        "y": 140,
        "wires": [["charging_handler"]]
    },
    {
        "id": "eneloop_aa_state",
        "type": "server-state-changed",
        "z": "battery_complete_tab",
        "name": "ENELOOP 3è™Ÿç‹€æ…‹",
        "server": "125d83f7.1a33dc",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": ["switch.tp_link_power_strip_eb2f_cha_shang_5"],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            }
        ],
        "x": 120,
        "y": 200,
        "wires": [["charging_handler"]]
    },
    {
        "id": "eneloop_aaa_state",
        "type": "server-state-changed",
        "z": "battery_complete_tab",
        "name": "ENELOOP 4è™Ÿç‹€æ…‹",
        "server": "125d83f7.1a33dc",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": ["switch.tp_link_power_strip_eb2f_cha_shang_6"],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            }
        ],
        "x": 120,
        "y": 260,
        "wires": [["charging_handler"]]
    },
    {
        "id": "charging_handler",
        "type": "function",
        "z": "battery_complete_tab",
        "name": "å……é›»è™•ç†å™¨",
        "func": "// ç²å–é…ç½®\nconst batteries = flow.get('batteries');\nif (!batteries) {\n    node.error('ç³»çµ±æœªåˆå§‹åŒ–ï¼Œè«‹å…ˆåŸ·è¡Œç³»çµ±åˆå§‹åŒ–');\n    return null;\n}\n\n// è§£æç‹€æ…‹è®ŠåŒ–\nconst newState = msg.payload;\nconst oldState = msg.data.old_state?.state;\nconst entityId = msg.data.entity_id;\n\n// æ‰¾åˆ°å°æ‡‰çš„é›»æ± \nlet batteryKey = null;\nlet battery = null;\n\nfor (const [key, config] of Object.entries(batteries)) {\n    if (config.entityId === entityId) {\n        batteryKey = key;\n        battery = config;\n        break;\n    }\n}\n\nif (!battery) {\n    node.error(`æ‰¾ä¸åˆ°å¯¦é«” ${entityId} çš„é…ç½®`);\n    return null;\n}\n\n// æº–å‚™è¼¸å‡º\nconst outputs = [null, null, null]; // [é€šçŸ¥, æ§åˆ¶, debug]\n\n// æª¢æŸ¥é–‹å•Ÿç‹€æ…‹ (off -> on)\nif (oldState === 'off' && newState === 'on') {\n    // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${batteryKey}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n    }\n    \n    // è¨˜éŒ„é–‹å§‹æ™‚é–“\n    const startTime = new Date();\n    flow.set(`${batteryKey}_start`, startTime.getTime());\n    \n    // æ›´æ–°å……é›»è¨˜éŒ„\n    const records = flow.get('chargingRecords') || {};\n    if (!records[batteryKey]) records[batteryKey] = {};\n    records[batteryKey].lastCharge = startTime.toISOString();\n    records[batteryKey].count = (records[batteryKey].count || 0) + 1;\n    flow.set('chargingRecords', records);\n    \n    // è¨­å®šè‡ªå‹•é—œé–‰è¨ˆæ™‚å™¨\n    const chargingMs = battery.chargingTime * 60 * 1000;\n    const newTimerId = setTimeout(() => {\n        // ç™¼é€é—œé–‰å‘½ä»¤\n        const controlMsg = {\n            payload: {\n                domain: battery.domain,\n                service: 'turn_off',\n                target: {\n                    entity_id: entityId\n                }\n            },\n            batteryKey: batteryKey,\n            action: 'auto_stop'\n        };\n        \n        // ç™¼é€åˆ°æ§åˆ¶è¼¸å‡º\n        node.send([null, controlMsg, {\n            payload: `è‡ªå‹•é—œé–‰ ${battery.name}`,\n            batteryKey: batteryKey,\n            action: 'auto_stop',\n            controlMsg: controlMsg\n        }]);\n        \n        flow.set(`${batteryKey}_timer`, null);\n    }, chargingMs);\n    \n    flow.set(`${batteryKey}_timer`, newTimerId);\n    \n    // æº–å‚™é€šçŸ¥è¨Šæ¯\n    const notifyMsg = {\n        payload: {\n            title: 'ğŸ”‹ å……é›»é–‹å§‹',\n            message: `ğŸ”‹ ${battery.name} é–‹å§‹å……é›»\\nâ±ï¸ é è¨ˆæ™‚é–“ï¼š${battery.chargingTime}åˆ†é˜\\nğŸ• é–‹å§‹æ™‚é–“ï¼š${startTime.toLocaleString('zh-TW')}`\n        },\n        batteryKey: batteryKey,\n        action: 'start'\n    };\n    \n    outputs[0] = notifyMsg;\n    outputs[2] = {\n        payload: `${battery.name} é–‹å§‹å……é›»`,\n        batteryKey: batteryKey,\n        chargingTime: battery.chargingTime,\n        timerId: newTimerId,\n        entityId: entityId,\n        domain: battery.domain\n    };\n}\n\n// æª¢æŸ¥é—œé–‰ç‹€æ…‹ (on -> off)\nelse if (newState === 'off' && oldState === 'on') {\n    // æ¸…é™¤è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${batteryKey}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n        flow.set(`${batteryKey}_timer`, null);\n    }\n    \n    // è¨ˆç®—å¯¦éš›æ™‚é–“\n    const startTime = flow.get(`${batteryKey}_start`);\n    const actualTime = startTime ? Math.round((Date.now() - startTime) / 60000) : 0;\n    \n    // æº–å‚™å®Œæˆé€šçŸ¥\n    const notifyMsg = {\n        payload: {\n            title: 'âœ… å……é›»å®Œæˆ',\n            message: `âœ… ${battery.name} å……é›»å®Œæˆ\\nâ±ï¸ å……é›»æ™‚é•·ï¼š${actualTime}åˆ†é˜\\nğŸ• å®Œæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        batteryKey: batteryKey,\n        action: 'complete'\n    };\n    \n    outputs[0] = notifyMsg;\n    outputs[2] = {\n        payload: `${battery.name} å……é›»å®Œæˆ`,\n        batteryKey: batteryKey,\n        actualTime: actualTime,\n        entityId: entityId\n    };\n}\n\nreturn outputs;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 200,
        "wires": [["notify_splitter"], ["device_control"], ["debug_charging"]]
    },
    {
        "id": "notify_splitter",
        "type": "function",
        "z": "battery_complete_tab",
        "name": "é€šçŸ¥åˆ†ç™¼å™¨",
        "func": "// æª¢æŸ¥æ˜¯å¦æœ‰é€šçŸ¥è¨Šæ¯\nif (!msg || !msg.payload) {\n    return [null, null, null];\n}\n\n// å‹•æ…‹éœéŸ³æ™‚é–“æ§åˆ¶\nlet quietMode = flow.get('quietMode');\nif (quietMode === undefined) {\n    quietMode = false; // é è¨­é—œé–‰éœéŸ³ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰\n    flow.set('quietMode', quietMode);\n}\n\nlet isQuiet = false;\nif (quietMode) {\n    // éœéŸ³æ¨¡å¼é–‹å•Ÿæ™‚ï¼Œæª¢æŸ¥æ™‚é–“\n    const now = new Date();\n    const hour = now.getHours();\n    isQuiet = hour >= 22 || hour < 7;\n}\n// å¦‚æœéœéŸ³æ¨¡å¼é—œé–‰ï¼ŒisQuiet ä¿æŒ false\n\nif (isQuiet && msg.action !== 'error') {\n    return [null, null, null];\n}\n\nconst title = msg.payload.title;\nconst message = msg.payload.message;\n\n// å‰µå»ºä¸‰å€‹é€šçŸ¥è¨Šæ¯ - ä¿®æ­£ç‰ˆ\nconst notify1 = {\n    payload: {\n        title: title,\n        message: message\n    }\n};\n\nconst notify2 = {\n    payload: {\n        title: title,\n        message: message\n    }\n};\n\nconst notify3 = {\n    payload: {\n        title: title,\n        message: message\n    }\n};\n\nreturn [notify1, notify2, notify3];",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 160,
        "wires": [["notify_helper"], ["synology_chat"], ["telegram_bot"]]
    },
    {
        "id": "notify_helper",
        "type": "api-call-service",
        "z": "battery_complete_tab",
        "name": "NotifyHelper (ming)",
        "server": "125d83f7.1a33dc",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify_person",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\": payload.title, \"message\": payload.message}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify_person",
        "x": 800,
        "y": 120,
        "wires": [["debug_notify1"]]
    },
    {
        "id": "synology_chat",
        "type": "api-call-service",
        "z": "battery_complete_tab",
        "name": "Synology Chat",
        "server": "125d83f7.1a33dc",
        "version": 7,
        "debugenabled": false,
        "action": "notify.synology_chat_bot_3",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "{\"message\": payload.message, \"targets\": [\"person.ming\"]}",
                "valueType": "jsonata"
            }
        ],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "synology_chat_bot_3",
        "x": 800,
        "y": 160,
        "wires": [["debug_notify2"]]
    },
    {
        "id": "telegram_bot",
        "type": "api-call-service",
        "z": "battery_complete_tab",
        "name": "Telegram",
        "server": "125d83f7.1a33dc",
        "version": 7,
        "debugenabled": false,
        "action": "notify.telegram",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\": payload.title, \"message\": payload.message}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "telegram",
        "x": 800,
        "y": 200,
        "wires": [["debug_notify3"]]
    },
    {
        "id": "device_control",
        "type": "api-call-service",
        "z": "battery_complete_tab",
        "name": "è¨­å‚™æ§åˆ¶",
        "server": "125d83f7.1a33dc",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [
            {
                "property": "domain",
                "propertyType": "msg",
                "value": "payload.domain",
                "valueType": "jsonata"
            },
            {
                "property": "service",
                "propertyType": "msg",
                "value": "payload.service",
                "valueType": "jsonata"
            },
            {
                "property": "target",
                "propertyType": "msg",
                "value": "payload.target",
                "valueType": "jsonata"
            }
        ],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "{{domain}}",
        "service": "{{service}}",
        "x": 580,
        "y": 240,
        "wires": [["debug_control"]]
    },
    {
        "id": "maintenance_check",
        "type": "inject",
        "z": "battery_complete_tab",
        "name": "ç¶­è­·æª¢æŸ¥",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "0 9 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "maintenance_check",
        "payloadType": "str",
        "x": 120,
        "y": 380,
        "wires": [["maintenance_logic"]]
    },
    {
        "id": "manual_maintenance",
        "type": "inject",
        "z": "battery_complete_tab",
        "name": "æ‰‹å‹•ç¶­è­·æª¢æŸ¥",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "maintenance_check",
        "payloadType": "str",
        "x": 130,
        "y": 420,
        "wires": [["maintenance_logic"]]
    },
    {
        "id": "maintenance_logic",
        "type": "function",
        "z": "battery_complete_tab",
        "name": "ç¶­è­·æª¢æŸ¥é‚è¼¯",
        "func": "// ç²å–é…ç½®\nconst batteries = flow.get('batteries');\nconst records = flow.get('chargingRecords') || {};\n\nif (!batteries) {\n    node.error('ç³»çµ±æœªåˆå§‹åŒ–');\n    return null;\n}\n\nconst now = new Date();\nconst maintenanceNeeded = [];\n\n// æª¢æŸ¥æ¯å€‹é›»æ± çš„ç¶­è­·éœ€æ±‚\nfor (const [key, battery] of Object.entries(batteries)) {\n    const record = records[key];\n    \n    if (!record || !record.lastCharge) {\n        // å¾æœªå……é›»ï¼Œéœ€è¦ç¶­è­·\n        maintenanceNeeded.push({\n            key: key,\n            battery: battery,\n            reason: 'å¾æœªå……é›»',\n            daysSince: 'æœªçŸ¥'\n        });\n        continue;\n    }\n    \n    const lastCharge = new Date(record.lastCharge);\n    const daysSince = Math.floor((now - lastCharge) / (1000 * 60 * 60 * 24));\n    \n    if (daysSince >= battery.maintenanceDays) {\n        maintenanceNeeded.push({\n            key: key,\n            battery: battery,\n            reason: `è¶…é${battery.maintenanceDays}å¤©æœªå……é›»`,\n            daysSince: daysSince\n        });\n    }\n}\n\n// æº–å‚™è¼¸å‡º\nconst outputs = [null, null, null]; // [é€šçŸ¥, æ§åˆ¶, debug]\n\nif (maintenanceNeeded.length > 0) {\n    // æº–å‚™ç¶­è­·é€šçŸ¥\n    const batteryList = maintenanceNeeded.map(item => \n        `â€¢ ${item.battery.name} (${item.daysSince}å¤©å‰)`\n    ).join('\\n');\n    \n    const notifyMsg = {\n        payload: {\n            title: 'ğŸ”§ é›»æ± ç¶­è­·æé†’',\n            message: `ğŸ”§ ä»¥ä¸‹é›»æ± éœ€è¦ç¶­è­·å……é›»ï¼š\\n${batteryList}\\n\\nå»ºè­°é€²è¡Œç¶­è­·å……é›»ä»¥ä¿æŒé›»æ± æ€§èƒ½ã€‚`\n        },\n        action: 'maintenance_alert',\n        maintenanceList: maintenanceNeeded\n    };\n    \n    outputs[0] = notifyMsg;\n    \n    // è‡ªå‹•é–‹å•Ÿç¬¬ä¸€å€‹éœ€è¦ç¶­è­·çš„é›»æ± \n    const firstBattery = maintenanceNeeded[0];\n    const controlMsg = {\n        payload: {\n            domain: firstBattery.battery.domain,\n            service: 'turn_on',\n            target: {\n                entity_id: firstBattery.battery.entityId\n            }\n        },\n        batteryKey: firstBattery.key,\n        action: 'maintenance_start'\n    };\n    \n    outputs[1] = controlMsg;\n} else {\n    // ç„¡éœ€ç¶­è­·\n    const notifyMsg = {\n        payload: {\n            title: 'âœ… é›»æ± ç‹€æ…‹è‰¯å¥½',\n            message: 'âœ… æ‰€æœ‰é›»æ± ç‹€æ…‹è‰¯å¥½ï¼Œç„¡éœ€ç¶­è­·å……é›»ã€‚'\n        },\n        action: 'maintenance_ok'\n    };\n    \n    outputs[0] = notifyMsg;\n}\n\noutputs[2] = {\n    payload: `ç¶­è­·æª¢æŸ¥å®Œæˆ`,\n    maintenanceNeeded: maintenanceNeeded,\n    totalBatteries: Object.keys(batteries).length,\n    checkTime: now.toISOString()\n};\n\nreturn outputs;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 400,
        "wires": [["notify_splitter"], ["device_control"], ["debug_maintenance"]]
    },
    {
        "id": "status_report",
        "type": "inject",
        "z": "battery_complete_tab",
        "name": "ç‹€æ…‹å ±å‘Š",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "status_report",
        "payloadType": "str",
        "x": 120,
        "y": 480,
        "wires": [["status_logic"]]
    },
    {
        "id": "status_logic",
        "type": "function",
        "z": "battery_complete_tab",
        "name": "ç‹€æ…‹å ±å‘Šé‚è¼¯",
        "func": "// ç²å–é…ç½®å’Œè¨˜éŒ„\nconst batteries = flow.get('batteries');\nconst records = flow.get('chargingRecords') || {};\n\nif (!batteries) {\n    node.error('ç³»çµ±æœªåˆå§‹åŒ–');\n    return null;\n}\n\nconst now = new Date();\nlet statusReport = 'ğŸ“Š é›»æ± å……é›»ç³»çµ±ç‹€æ…‹å ±å‘Š\\n\\n';\n\n// ç³»çµ±è³‡è¨Š\nstatusReport += `ğŸ• å ±å‘Šæ™‚é–“ï¼š${now.toLocaleString('zh-TW')}\\n`;\nstatusReport += `ğŸ”‹ ç®¡ç†é›»æ± æ•¸é‡ï¼š${Object.keys(batteries).length}\\n\\n`;\n\n// å„é›»æ± ç‹€æ…‹\nfor (const [key, battery] of Object.entries(batteries)) {\n    const record = records[key] || {};\n    \n    statusReport += `ğŸ”‹ ${battery.name}\\n`;\n    statusReport += `   ğŸ“ æ’åº§ï¼š${battery.entityId}\\n`;\n    statusReport += `   â±ï¸ å……é›»æ™‚é–“ï¼š${battery.chargingTime}åˆ†é˜\\n`;\n    statusReport += `   ğŸ”§ ç¶­è­·é€±æœŸï¼š${battery.maintenanceDays}å¤©\\n`;\n    \n    if (record.lastCharge) {\n        const lastCharge = new Date(record.lastCharge);\n        const daysSince = Math.floor((now - lastCharge) / (1000 * 60 * 60 * 24));\n        statusReport += `   ğŸ“… ä¸Šæ¬¡å……é›»ï¼š${lastCharge.toLocaleString('zh-TW')} (${daysSince}å¤©å‰)\\n`;\n        statusReport += `   ğŸ“ˆ å……é›»æ¬¡æ•¸ï¼š${record.count || 0}æ¬¡\\n`;\n        \n        // ç¶­è­·ç‹€æ…‹\n        if (daysSince >= battery.maintenanceDays) {\n            statusReport += `   âš ï¸ ç‹€æ…‹ï¼šéœ€è¦ç¶­è­·å……é›»\\n`;\n        } else {\n            statusReport += `   âœ… ç‹€æ…‹ï¼šè‰¯å¥½\\n`;\n        }\n    } else {\n        statusReport += `   ğŸ“… ä¸Šæ¬¡å……é›»ï¼šå¾æœªå……é›»\\n`;\n        statusReport += `   ğŸ“ˆ å……é›»æ¬¡æ•¸ï¼š0æ¬¡\\n`;\n        statusReport += `   âš ï¸ ç‹€æ…‹ï¼šéœ€è¦åˆæ¬¡å……é›»\\n`;\n    }\n    \n    statusReport += '\\n';\n}\n\n// æº–å‚™é€šçŸ¥è¨Šæ¯\nconst notifyMsg = {\n    payload: {\n        title: 'ğŸ“Š ç³»çµ±ç‹€æ…‹å ±å‘Š',\n        message: statusReport\n    },\n    action: 'status_report'\n};\n\nconst debugMsg = {\n    payload: 'ç‹€æ…‹å ±å‘Šå·²ç”Ÿæˆ',\n    batteries: batteries,\n    records: records,\n    reportTime: now.toISOString()\n};\n\nreturn [notifyMsg, null, debugMsg];",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 480,
        "wires": [["notify_splitter"], [], ["debug_status"]]
    },
    {
        "id": "debug_charging",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "å……é›»Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 280,
        "wires": []
    },
    {
        "id": "debug_notify1",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "NotifyHelper Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 120,
        "wires": []
    },
    {
        "id": "debug_notify2",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "Synology Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1010,
        "y": 160,
        "wires": []
    },
    {
        "id": "debug_notify3",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "Telegram Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1010,
        "y": 200,
        "wires": []
    },
    {
        "id": "debug_control",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "æ§åˆ¶Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 760,
        "y": 240,
        "wires": []
    },
    {
        "id": "debug_maintenance",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "ç¶­è­·Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 440,
        "wires": []
    },
    {
        "id": "debug_status",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "ç‹€æ…‹Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 500,
        "y": 520,
        "wires": []
    },
    {
        "id": "test_notify",
        "type": "inject",
        "z": "battery_complete_tab",
        "name": "æ¸¬è©¦é€šçŸ¥",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"title\":\"ğŸ§ª æ¸¬è©¦é€šçŸ¥ (ming)\",\"message\":\"é€™æ˜¯ä¸€å€‹æ¸¬è©¦é€šçŸ¥è¨Šæ¯ï¼Œç”¨æ–¼æª¢æŸ¥é€šçŸ¥æœå‹™æ˜¯å¦æ­£å¸¸é‹ä½œã€‚\\n\\nğŸ“± NotifyHelper: æŒ‡å®šé€šçŸ¥ ming (é™£åˆ—æ ¼å¼)\\nğŸ’¬ Synology Chat: ç¾¤çµ„é€šçŸ¥\\nğŸ“¨ Telegram: ç¾¤çµ„é€šçŸ¥\\n\\nå¦‚æœNotifyHelperä»æœ‰éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥Home Assistantä¸­mingç”¨æˆ¶çš„è¨­å®šã€‚\"}",
        "payloadType": "json",
        "x": 120,
        "y": 560,
        "wires": [["notify_splitter"]]
    },
    {
        "id": "test_control",
        "type": "inject",
        "z": "battery_complete_tab",
        "name": "æ¸¬è©¦è¨­å‚™æ§åˆ¶",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"domain\":\"switch\",\"service\":\"turn_off\",\"target\":{\"entity_id\":\"switch.tp_link_power_strip_eb2f_cha_shang_4\"}}",
        "payloadType": "json",
        "x": 130,
        "y": 600,
        "wires": [["device_control"]]
    },
    {
        "id": "toggle_quiet_mode",
        "type": "inject",
        "z": "battery_complete_tab",
        "name": "åˆ‡æ›éœéŸ³æ¨¡å¼",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "toggle_quiet",
        "payloadType": "str",
        "x": 130,
        "y": 640,
        "wires": [["quiet_mode_logic"]]
    },
    {
        "id": "quiet_mode_logic",
        "type": "function",
        "z": "battery_complete_tab",
        "name": "éœéŸ³æ¨¡å¼æ§åˆ¶",
        "func": "// ç²å–ç•¶å‰éœéŸ³æ¨¡å¼ç‹€æ…‹\nlet quietMode = flow.get('quietMode');\nif (quietMode === undefined) {\n    quietMode = false; // é è¨­é—œé–‰éœéŸ³ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰\n}\n\n// åˆ‡æ›éœéŸ³æ¨¡å¼\nquietMode = !quietMode;\nflow.set('quietMode', quietMode);\n\n// æº–å‚™ç‹€æ…‹è¨Šæ¯\nconst statusMsg = {\n    payload: {\n        title: quietMode ? 'ğŸ”• éœéŸ³æ¨¡å¼å·²é–‹å•Ÿ' : 'ğŸ”” éœéŸ³æ¨¡å¼å·²é—œé–‰',\n        message: quietMode ? \n            'ğŸ”• éœéŸ³æ¨¡å¼å·²é–‹å•Ÿ\\nâ° 22:00-07:00 æœŸé–“ä¸æœƒç™¼é€é€šçŸ¥' : \n            'ğŸ”” éœéŸ³æ¨¡å¼å·²é—œé–‰\\nğŸ“± æ‰€æœ‰æ™‚é–“éƒ½æœƒç™¼é€é€šçŸ¥ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰'\n    },\n    action: 'quiet_mode_change'\n};\n\nconst debugMsg = {\n    payload: `éœéŸ³æ¨¡å¼: ${quietMode ? 'é–‹å•Ÿ' : 'é—œé–‰'}`,\n    quietMode: quietMode,\n    timestamp: new Date().toISOString()\n};\n\nnode.status({\n    fill: quietMode ? \"yellow\" : \"green\",\n    shape: \"dot\",\n    text: quietMode ? \"éœéŸ³æ¨¡å¼\" : \"æ­£å¸¸æ¨¡å¼\"\n});\n\nreturn [statusMsg, debugMsg];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 640,
        "wires": [["notify_splitter"], ["debug_quiet"]]
    },
    {
        "id": "debug_quiet",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "éœéŸ³Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 540,
        "y": 680,
        "wires": []
    },
    {
        "id": "125d83f7.1a33dc",
        "type": "server",
        "name": "Home Assistant",
        "addon": true
    }
]
