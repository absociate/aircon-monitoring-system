[
    {
        "id": "battery_complete_tab",
        "type": "tab",
        "label": "æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - ä¿®æ­£ç‰ˆ",
        "disabled": false,
        "info": "å®Œæ•´çš„æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - ä¿®æ­£ç‰ˆ\n\nä¿®æ­£å…§å®¹ï¼š\n1. ç‰§ç”°é›»æ± domainæ”¹ç‚ºswitch\n2. è¨­å‚™æŽ§åˆ¶ç¯€é»žæ­£ç¢ºé…ç½®\n3. å®Œæ•´çš„debugè¼¸å‡º\n\nåŠŸèƒ½ï¼š\n1. æ‰‹å‹•å……é›»è‡ªå‹•è¨ˆæ™‚é—œé–‰\n2. ä¸‰å€‹ç¨ç«‹çš„é€šçŸ¥æœå‹™\n3. å®Œæ•´çš„debugè¼¸å‡º\n4. ç¶­è­·å……é›»åŠŸèƒ½\n\næ”¯æ´è¨­å‚™ï¼š\n- ç‰§ç”°BL1041B (switch.tp_link_power_strip_eb2f_cha_shang_4)\n- ENELOOP 3è™Ÿ (switch.tp_link_power_strip_eb2f_cha_shang_5)\n- ENELOOP 4è™Ÿ (switch.tp_link_power_strip_eb2f_cha_shang_6)\n\né€šçŸ¥æœå‹™ï¼š\n- NotifyHelper (notify.notify)\n- Synology Chat (notify.synology_chat_bot_3)\n- Telegram (notify.telegram)",
        "env": []
    },
    {
        "id": "init_system",
        "type": "inject",
        "z": "battery_complete_tab",
        "name": "ç³»çµ±åˆå§‹åŒ–",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 3,
        "topic": "",
        "payload": "initialize",
        "payloadType": "str",
        "x": 120,
        "y": 60,
        "wires": [["setup_config"]]
    },
    {
        "id": "setup_config",
        "type": "function",
        "z": "battery_complete_tab",
        "name": "è¼‰å…¥é…ç½®",
        "func": "// é›»æ± é…ç½® - ä¿®æ­£ç‰ˆ\nconst batteries = {\n    makita: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_4',\n        name: 'ç‰§ç”°BL1041Bå……é›»é›»æ± ',\n        chargingTime: 90,\n        maintenanceDays: 30,\n        domain: 'switch'  // ä¿®æ­£ï¼šæ”¹ç‚ºswitch\n    },\n    eneloop_aa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_5',\n        name: 'ENELOOP 3è™Ÿå……é›»é›»æ± ',\n        chargingTime: 240,\n        maintenanceDays: 60,\n        domain: 'switch'\n    },\n    eneloop_aaa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_6',\n        name: 'ENELOOP 4è™Ÿå……é›»é›»æ± ',\n        chargingTime: 210,\n        maintenanceDays: 60,\n        domain: 'switch'\n    }\n};\n\n// é€šçŸ¥æœå‹™é…ç½®\nconst notifications = {\n    notifyHelper: {\n        service: 'notify',\n        enabled: true\n    },\n    synologyChat: {\n        service: 'synology_chat_bot_3',\n        enabled: true\n    },\n    telegram: {\n        service: 'telegram',\n        enabled: true\n    }\n};\n\n// å„²å­˜é…ç½®\nflow.set('batteries', batteries);\nflow.set('notifications', notifications);\n\n// åˆå§‹åŒ–å……é›»è¨˜éŒ„\nconst records = flow.get('chargingRecords') || {};\nObject.keys(batteries).forEach(key => {\n    if (!records[key]) {\n        records[key] = {\n            lastCharge: null,\n            count: 0\n        };\n    }\n});\nflow.set('chargingRecords', records);\n\nmsg.payload = {\n    status: 'initialized',\n    batteries: Object.keys(batteries).length,\n    notifications: Object.keys(notifications).length,\n    timestamp: new Date().toISOString(),\n    config: batteries\n};\n\nnode.status({fill:\"green\", shape:\"dot\", text:\"ç³»çµ±å·²åˆå§‹åŒ–\"});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 60,
        "wires": [["debug_init"]]
    },
    {
        "id": "debug_init",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "åˆå§‹åŒ–Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 500,
        "y": 60,
        "wires": []
    },
    {
        "id": "makita_state",
        "type": "server-state-changed",
        "z": "battery_complete_tab",
        "name": "ç‰§ç”°é›»æ± ç‹€æ…‹",
        "server": "125d83f7.1a33dc",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": ["switch.tp_link_power_strip_eb2f_cha_shang_4"],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            }
        ],
        "x": 120,
        "y": 140,
        "wires": [["charging_handler"]]
    },
    {
        "id": "eneloop_aa_state",
        "type": "server-state-changed",
        "z": "battery_complete_tab",
        "name": "ENELOOP 3è™Ÿç‹€æ…‹",
        "server": "125d83f7.1a33dc",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": ["switch.tp_link_power_strip_eb2f_cha_shang_5"],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            }
        ],
        "x": 120,
        "y": 200,
        "wires": [["charging_handler"]]
    },
    {
        "id": "eneloop_aaa_state",
        "type": "server-state-changed",
        "z": "battery_complete_tab",
        "name": "ENELOOP 4è™Ÿç‹€æ…‹",
        "server": "125d83f7.1a33dc",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": ["switch.tp_link_power_strip_eb2f_cha_shang_6"],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            }
        ],
        "x": 120,
        "y": 260,
        "wires": [["charging_handler"]]
    },
    {
        "id": "charging_handler",
        "type": "function",
        "z": "battery_complete_tab",
        "name": "å……é›»è™•ç†å™¨",
        "func": "// ç²å–é…ç½®\nconst batteries = flow.get('batteries');\nif (!batteries) {\n    node.error('ç³»çµ±æœªåˆå§‹åŒ–ï¼Œè«‹å…ˆåŸ·è¡Œç³»çµ±åˆå§‹åŒ–');\n    return null;\n}\n\n// è§£æžç‹€æ…‹è®ŠåŒ–\nconst newState = msg.payload;\nconst oldState = msg.data.old_state?.state;\nconst entityId = msg.data.entity_id;\n\n// æ‰¾åˆ°å°æ‡‰çš„é›»æ± \nlet batteryKey = null;\nlet battery = null;\n\nfor (const [key, config] of Object.entries(batteries)) {\n    if (config.entityId === entityId) {\n        batteryKey = key;\n        battery = config;\n        break;\n    }\n}\n\nif (!battery) {\n    node.error(`æ‰¾ä¸åˆ°å¯¦é«” ${entityId} çš„é…ç½®`);\n    return null;\n}\n\n// æº–å‚™è¼¸å‡º\nconst outputs = [null, null, null]; // [é€šçŸ¥, æŽ§åˆ¶, debug]\n\n// æª¢æŸ¥é–‹å•Ÿç‹€æ…‹ (off -> on)\nif (oldState === 'off' && newState === 'on') {\n    // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${batteryKey}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n    }\n    \n    // è¨˜éŒ„é–‹å§‹æ™‚é–“\n    const startTime = new Date();\n    flow.set(`${batteryKey}_start`, startTime.getTime());\n    \n    // æ›´æ–°å……é›»è¨˜éŒ„\n    const records = flow.get('chargingRecords') || {};\n    if (!records[batteryKey]) records[batteryKey] = {};\n    records[batteryKey].lastCharge = startTime.toISOString();\n    records[batteryKey].count = (records[batteryKey].count || 0) + 1;\n    flow.set('chargingRecords', records);\n    \n    // è¨­å®šè‡ªå‹•é—œé–‰è¨ˆæ™‚å™¨\n    const chargingMs = battery.chargingTime * 60 * 1000;\n    const newTimerId = setTimeout(() => {\n        // ç™¼é€é—œé–‰å‘½ä»¤ - ä¿®æ­£ç‰ˆ\n        const controlMsg = {\n            payload: {\n                domain: battery.domain,\n                service: 'turn_off',\n                target: {\n                    entity_id: entityId\n                }\n            },\n            batteryKey: batteryKey,\n            action: 'auto_stop'\n        };\n        \n        // ç™¼é€åˆ°æŽ§åˆ¶è¼¸å‡º\n        node.send([null, controlMsg, {\n            payload: `è‡ªå‹•é—œé–‰ ${battery.name}`,\n            batteryKey: batteryKey,\n            action: 'auto_stop',\n            controlMsg: controlMsg\n        }]);\n        \n        flow.set(`${batteryKey}_timer`, null);\n    }, chargingMs);\n    \n    flow.set(`${batteryKey}_timer`, newTimerId);\n    \n    // æº–å‚™é€šçŸ¥è¨Šæ¯\n    const notifyMsg = {\n        payload: {\n            title: 'ðŸ”‹ å……é›»é–‹å§‹',\n            message: `ðŸ”‹ ${battery.name} é–‹å§‹å……é›»\\nâ±ï¸ é è¨ˆæ™‚é–“ï¼š${battery.chargingTime}åˆ†é˜\\nðŸ• é–‹å§‹æ™‚é–“ï¼š${startTime.toLocaleString('zh-TW')}`\n        },\n        batteryKey: batteryKey,\n        action: 'start'\n    };\n    \n    outputs[0] = notifyMsg;\n    outputs[2] = {\n        payload: `${battery.name} é–‹å§‹å……é›»`,\n        batteryKey: batteryKey,\n        chargingTime: battery.chargingTime,\n        timerId: newTimerId,\n        entityId: entityId,\n        domain: battery.domain\n    };\n}\n\n// æª¢æŸ¥é—œé–‰ç‹€æ…‹ (on -> off)\nelse if (newState === 'off' && oldState === 'on') {\n    // æ¸…é™¤è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${batteryKey}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n        flow.set(`${batteryKey}_timer`, null);\n    }\n    \n    // è¨ˆç®—å¯¦éš›æ™‚é–“\n    const startTime = flow.get(`${batteryKey}_start`);\n    const actualTime = startTime ? Math.round((Date.now() - startTime) / 60000) : 0;\n    \n    // æº–å‚™å®Œæˆé€šçŸ¥\n    const notifyMsg = {\n        payload: {\n            title: 'âœ… å……é›»å®Œæˆ',\n            message: `âœ… ${battery.name} å……é›»å®Œæˆ\\nâ±ï¸ å……é›»æ™‚é•·ï¼š${actualTime}åˆ†é˜\\nðŸ• å®Œæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        batteryKey: batteryKey,\n        action: 'complete'\n    };\n    \n    outputs[0] = notifyMsg;\n    outputs[2] = {\n        payload: `${battery.name} å……é›»å®Œæˆ`,\n        batteryKey: batteryKey,\n        actualTime: actualTime,\n        entityId: entityId\n    };\n}\n\nreturn outputs;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 200,
        "wires": [["notify_splitter"], ["device_control"], ["debug_charging"]]
    },
    {
        "id": "notify_splitter",
        "type": "function",
        "z": "battery_complete_tab",
        "name": "é€šçŸ¥åˆ†ç™¼å™¨",
        "func": "// æª¢æŸ¥æ˜¯å¦æœ‰é€šçŸ¥è¨Šæ¯\nif (!msg || !msg.payload) {\n    return [null, null, null];\n}\n\n// æª¢æŸ¥éœéŸ³æ™‚é–“ (22:00-07:00)\nconst now = new Date();\nconst hour = now.getHours();\nconst isQuiet = hour >= 22 || hour < 7;\n\nif (isQuiet && msg.action !== 'error') {\n    return [null, null, null];\n}\n\nconst title = msg.payload.title;\nconst message = msg.payload.message;\n\n// å‰µå»ºä¸‰å€‹é€šçŸ¥è¨Šæ¯\nconst notify1 = {\n    payload: {\n        domain: 'notify',\n        service: 'notify',\n        data: {\n            title: title,\n            message: message\n        }\n    }\n};\n\nconst notify2 = {\n    payload: {\n        domain: 'notify',\n        service: 'synology_chat_bot_3',\n        data: {\n            title: title,\n            message: message\n        }\n    }\n};\n\nconst notify3 = {\n    payload: {\n        domain: 'notify',\n        service: 'telegram',\n        data: {\n            title: title,\n            message: message\n        }\n    }\n};\n\nreturn [notify1, notify2, notify3];",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 160,
        "wires": [["notify_helper"], ["synology_chat"], ["telegram_bot"]]
    },
    {
        "id": "notify_helper",
        "type": "api-call-service",
        "z": "battery_complete_tab",
        "name": "NotifyHelper",
        "server": "125d83f7.1a33dc",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\": msg.payload.data.title, \"message\": msg.payload.data.message}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 800,
        "y": 120,
        "wires": [["debug_notify1"]]
    },
    {
        "id": "synology_chat",
        "type": "api-call-service",
        "z": "battery_complete_tab",
        "name": "Synology Chat",
        "server": "125d83f7.1a33dc",
        "version": 7,
        "debugenabled": false,
        "action": "notify.synology_chat_bot_3",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\": msg.payload.data.title, \"message\": msg.payload.data.message}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "synology_chat_bot_3",
        "x": 800,
        "y": 160,
        "wires": [["debug_notify2"]]
    },
    {
        "id": "telegram_bot",
        "type": "api-call-service",
        "z": "battery_complete_tab",
        "name": "Telegram",
        "server": "125d83f7.1a33dc",
        "version": 7,
        "debugenabled": false,
        "action": "notify.telegram",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\": msg.payload.data.title, \"message\": msg.payload.data.message}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "telegram",
        "x": 800,
        "y": 200,
        "wires": [["debug_notify3"]]
    },
    {
        "id": "device_control",
        "type": "api-call-service",
        "z": "battery_complete_tab",
        "name": "è¨­å‚™æŽ§åˆ¶ - ä¿®æ­£ç‰ˆ",
        "server": "125d83f7.1a33dc",
        "version": 7,
        "debugenabled": false,
        "action": "{{payload.domain}}.{{payload.service}}",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": ["{{payload.target.entity_id}}"],
        "labelId": [],
        "data": "{}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "",
        "service": "",
        "x": 580,
        "y": 240,
        "wires": [["debug_control"]]
    },
    {
        "id": "debug_charging",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "å……é›»Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 280,
        "wires": []
    },
    {
        "id": "debug_notify1",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "NotifyHelper Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 120,
        "wires": []
    },
    {
        "id": "debug_notify2",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "Synology Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1010,
        "y": 160,
        "wires": []
    },
    {
        "id": "debug_notify3",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "Telegram Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1010,
        "y": 200,
        "wires": []
    },
    {
        "id": "debug_control",
        "type": "debug",
        "z": "battery_complete_tab",
        "name": "æŽ§åˆ¶Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 760,
        "y": 240,
        "wires": []
    },
    {
        "id": "test_control",
        "type": "inject",
        "z": "battery_complete_tab",
        "name": "æ¸¬è©¦è¨­å‚™æŽ§åˆ¶",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"domain\":\"switch\",\"service\":\"turn_off\",\"target\":{\"entity_id\":\"switch.tp_link_power_strip_eb2f_cha_shang_4\"}}",
        "payloadType": "json",
        "x": 130,
        "y": 320,
        "wires": [["device_control"]]
    },
    {
        "id": "125d83f7.1a33dc",
        "type": "server",
        "name": "Home Assistant",
        "addon": true
    }
]
