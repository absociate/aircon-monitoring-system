[
    {
        "id": "7aa6bd9d6c51a86b",
        "type": "tab",
        "label": "æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - é‡å•Ÿå®‰å…¨ç‰ˆ",
        "disabled": false,
        "info": "æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - é‡å•Ÿå®‰å…¨ç‰ˆ\n\nğŸ”„ é‡å•Ÿå®‰å…¨è¨­è¨ˆï¼š\n1. ç³»çµ±å•Ÿå‹•æ™‚è‡ªå‹•æª¢æŸ¥å……é›»ç‹€æ…‹\n2. ä½¿ç”¨contextæŒä¹…åŒ–å­˜å„²å……é›»è¨˜éŒ„\n3. é‡å•Ÿå¾Œè‡ªå‹•æ¢å¾©ä¿è­·æ©Ÿåˆ¶\n4. å®šæœŸæª¢æŸ¥é˜²æ­¢è¨ˆæ™‚å™¨å¤±æ•ˆ\n5. ç·Šæ€¥å®‰å…¨é—œé–‰åŠŸèƒ½\n\nğŸ›¡ï¸ å¤šé‡å®‰å…¨ä¿è­·ï¼š\n- å•Ÿå‹•æª¢æŸ¥ï¼šç³»çµ±å•Ÿå‹•3ç§’å¾Œè‡ªå‹•æª¢æŸ¥\n- å®šæœŸæª¢æŸ¥ï¼šæ¯5åˆ†é˜æª¢æŸ¥ä¸€æ¬¡å……é›»ç‹€æ…‹\n- æŒä¹…åŒ–è¨˜éŒ„ï¼šä½¿ç”¨contextå­˜å„²ï¼Œé‡å•Ÿå¾Œä»æœ‰æ•ˆ\n- æœ€å¤§æ™‚é–“é™åˆ¶ï¼šçµ•å°ä¸å…è¨±è¶…éè¨­å®šæ™‚é–“150%\n- ç·Šæ€¥é—œé–‰ï¼šä¸€éµé—œé–‰æ‰€æœ‰å……é›»\n\nâš ï¸ å®‰å…¨æ™‚é–“è¨­å®šï¼š\n- ç‰§ç”°BL1041B: 90åˆ†é˜ â†’ æœ€å¤§135åˆ†é˜\n- ENELOOP 3è™Ÿ: 240åˆ†é˜ â†’ æœ€å¤§360åˆ†é˜\n- ENELOOP 4è™Ÿ: 210åˆ†é˜ â†’ æœ€å¤§315åˆ†é˜\n\næ”¯æ´è¨­å‚™ï¼š\n- ç‰§ç”°BL1041B (switch.tp_link_power_strip_eb2f_cha_shang_4)\n- ENELOOP 3è™Ÿ (switch.tp_link_power_strip_eb2f_cha_shang_5)\n- ENELOOP 4è™Ÿ (switch.tp_link_power_strip_eb2f_cha_shang_6)",
        "env": []
    },
    {
        "id": "system_startup",
        "type": "inject",
        "z": "7aa6bd9d6c51a86b",
        "name": "ğŸ”„ ç³»çµ±å•Ÿå‹•æª¢æŸ¥",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 3,
        "topic": "",
        "payload": "startup_check",
        "payloadType": "str",
        "x": 120,
        "y": 20,
        "wires": [["startup_recovery"]]
    },
    {
        "id": "startup_recovery",
        "type": "function",
        "z": "7aa6bd9d6c51a86b",
        "name": "å•Ÿå‹•æ¢å¾©æª¢æŸ¥",
        "func": "// é›»æ± é…ç½®\nconst batteries = {\n    makita: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_4',\n        name: 'ç‰§ç”°BL1041Bå……é›»é›»æ± ',\n        chargingTime: 90,\n        maxTime: 135, // 150%å®‰å…¨é™åˆ¶\n        domain: 'switch'\n    },\n    eneloop_aa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_5',\n        name: 'ENELOOP 3è™Ÿå……é›»é›»æ± ',\n        chargingTime: 240,\n        maxTime: 360, // 150%å®‰å…¨é™åˆ¶\n        domain: 'switch'\n    },\n    eneloop_aaa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_6',\n        name: 'ENELOOP 4è™Ÿå……é›»é›»æ± ',\n        chargingTime: 210,\n        maxTime: 315, // 150%å®‰å…¨é™åˆ¶\n        domain: 'switch'\n    }\n};\n\n// å„²å­˜é…ç½®åˆ°flowï¼ˆé‡å•Ÿå¾Œéœ€è¦é‡æ–°è¨­å®šï¼‰\nflow.set('batteries', batteries);\nflow.set('quietMode', false);\n\nconst now = Date.now();\nconst outputs = [null, null, null]; // [é€šçŸ¥, æ§åˆ¶, debug]\nlet recoveredCharging = [];\nlet emergencyStops = [];\n\n// æª¢æŸ¥æ¯å€‹é›»æ± çš„æŒä¹…åŒ–å……é›»è¨˜éŒ„\nfor (const [key, battery] of Object.entries(batteries)) {\n    const chargingInfo = context.get(`${key}_charging`);\n    \n    if (chargingInfo && chargingInfo.startTime) {\n        const chargingMinutes = Math.round((now - chargingInfo.startTime) / 60000);\n        \n        if (chargingMinutes >= battery.maxTime) {\n            // è¶…éæœ€å¤§æ™‚é–“ï¼Œéœ€è¦ç·Šæ€¥é—œé–‰\n            emergencyStops.push({\n                battery: battery,\n                key: key,\n                chargingMinutes: chargingMinutes,\n                startTime: new Date(chargingInfo.startTime)\n            });\n        } else if (chargingMinutes >= battery.chargingTime) {\n            // è¶…éæ­£å¸¸æ™‚é–“ä½†æœªé”æœ€å¤§æ™‚é–“ï¼Œéœ€è¦é—œé–‰\n            recoveredCharging.push({\n                battery: battery,\n                key: key,\n                chargingMinutes: chargingMinutes,\n                startTime: new Date(chargingInfo.startTime),\n                action: 'overdue_stop'\n            });\n        } else {\n            // æ­£å¸¸å……é›»ä¸­ï¼Œæ¢å¾©è¨ˆæ™‚å™¨\n            const remainingMs = (battery.chargingTime * 60 * 1000) - (now - chargingInfo.startTime);\n            \n            if (remainingMs > 0) {\n                // è¨­å®šæ¢å¾©çš„è¨ˆæ™‚å™¨\n                const timerId = setTimeout(() => {\n                    const controlMsg = {\n                        payload: {\n                            domain: battery.domain,\n                            service: 'turn_off',\n                            target: {\n                                entity_id: battery.entityId\n                            }\n                        },\n                        batteryKey: key,\n                        action: 'recovered_stop'\n                    };\n                    \n                    context.set(`${key}_charging`, null);\n                    \n                    node.send([null, controlMsg, {\n                        payload: `æ¢å¾©è¨ˆæ™‚å™¨é—œé–‰ ${battery.name}`,\n                        batteryKey: key,\n                        action: 'recovered_stop'\n                    }]);\n                    \n                    flow.set(`${key}_timer`, null);\n                }, remainingMs);\n                \n                flow.set(`${key}_timer`, timerId);\n                \n                recoveredCharging.push({\n                    battery: battery,\n                    key: key,\n                    chargingMinutes: chargingMinutes,\n                    remainingMinutes: Math.round(remainingMs / 60000),\n                    startTime: new Date(chargingInfo.startTime),\n                    action: 'timer_recovered'\n                });\n            }\n        }\n    }\n}\n\n// è™•ç†ç·Šæ€¥é—œé–‰\nif (emergencyStops.length > 0) {\n    const stopList = emergencyStops.map(item => \n        `â€¢ ${item.battery.name}: ${item.chargingMinutes}åˆ†é˜ (é–‹å§‹: ${item.startTime.toLocaleString('zh-TW')})`\n    ).join('\\n');\n    \n    outputs[0] = {\n        payload: {\n            title: 'ğŸš¨ é‡å•Ÿå¾Œç™¼ç¾éåº¦å……é›»',\n            message: `ğŸš¨ ç³»çµ±é‡å•Ÿå¾Œç™¼ç¾ä»¥ä¸‹è¨­å‚™éåº¦å……é›»ï¼Œç«‹å³é—œé–‰ï¼š\\n${stopList}\\n\\nâš ï¸ è«‹ç«‹å³æª¢æŸ¥é›»æ± å’Œå……é›»å™¨ç‹€æ…‹\\nğŸ”„ é‡å•Ÿæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        action: 'startup_emergency_stop'\n    };\n    \n    // é—œé–‰ç¬¬ä¸€å€‹éåº¦å……é›»çš„è¨­å‚™\n    const firstStop = emergencyStops[0];\n    outputs[1] = {\n        payload: {\n            domain: firstStop.battery.domain,\n            service: 'turn_off',\n            target: {\n                entity_id: firstStop.battery.entityId\n            }\n        },\n        batteryKey: firstStop.key,\n        action: 'startup_emergency_stop'\n    };\n    \n    // æ¸…é™¤éåº¦å……é›»çš„è¨˜éŒ„\n    emergencyStops.forEach(item => {\n        context.set(`${item.key}_charging`, null);\n    });\n}\n\n// è™•ç†æ¢å¾©çš„å……é›»\nelse if (recoveredCharging.length > 0) {\n    const recoveryList = recoveredCharging.map(item => {\n        if (item.action === 'timer_recovered') {\n            return `â€¢ ${item.battery.name}: å·²å……é›»${item.chargingMinutes}åˆ†é˜ï¼Œå‰©é¤˜${item.remainingMinutes}åˆ†é˜`;\n        } else {\n            return `â€¢ ${item.battery.name}: å·²å……é›»${item.chargingMinutes}åˆ†é˜ï¼Œéœ€è¦é—œé–‰`;\n        }\n    }).join('\\n');\n    \n    outputs[0] = {\n        payload: {\n            title: 'ğŸ”„ ç³»çµ±é‡å•Ÿæ¢å¾©',\n            message: `ğŸ”„ ç³»çµ±é‡å•Ÿå¾Œæ¢å¾©å……é›»ä¿è­·ï¼š\\n${recoveryList}\\n\\nâœ… è¨ˆæ™‚å™¨å·²æ¢å¾©ï¼Œå……é›»ä¿è­·æ­£å¸¸\\nğŸ”„ é‡å•Ÿæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        action: 'startup_recovery'\n    };\n    \n    // å¦‚æœæœ‰éœ€è¦ç«‹å³é—œé–‰çš„\n    const needStop = recoveredCharging.find(item => item.action === 'overdue_stop');\n    if (needStop) {\n        outputs[1] = {\n            payload: {\n                domain: needStop.battery.domain,\n                service: 'turn_off',\n                target: {\n                    entity_id: needStop.battery.entityId\n                }\n            },\n            batteryKey: needStop.key,\n            action: 'startup_overdue_stop'\n        };\n        \n        context.set(`${needStop.key}_charging`, null);\n    }\n}\n\n// æ­£å¸¸å•Ÿå‹•\nelse {\n    outputs[0] = {\n        payload: {\n            title: 'âœ… ç³»çµ±å•Ÿå‹•å®Œæˆ',\n            message: `âœ… æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ±å•Ÿå‹•å®Œæˆ\\n\\nğŸ”‹ ç®¡ç†è¨­å‚™ï¼š3å€‹\\nğŸ›¡ï¸ å®‰å…¨ä¿è­·ï¼šå·²å•Ÿç”¨\\nğŸ”„ å•Ÿå‹•æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\\n\\nç³»çµ±å·²æº–å‚™å°±ç·’ï¼Œå……é›»ä¿è­·åŠŸèƒ½æ­£å¸¸ã€‚`\n        },\n        action: 'startup_complete'\n    };\n}\n\n// Debugè¼¸å‡º\noutputs[2] = {\n    payload: 'ç³»çµ±å•Ÿå‹•æª¢æŸ¥å®Œæˆ',\n    emergencyStops: emergencyStops.length,\n    recoveredCharging: recoveredCharging.length,\n    startupTime: new Date().toISOString(),\n    batteries: Object.keys(batteries)\n};\n\nnode.status({\n    fill: emergencyStops.length > 0 ? \"red\" : recoveredCharging.length > 0 ? \"yellow\" : \"green\",\n    shape: \"dot\",\n    text: `å•Ÿå‹•: ${emergencyStops.length}ç·Šæ€¥, ${recoveredCharging.length}æ¢å¾©`\n});\n\nreturn outputs;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 20,
        "wires": [["d320c63adb96c9b2"], ["57a17fab27364441"], ["debug_startup"]]
    },
    {
        "id": "periodic_safety_check",
        "type": "inject",
        "z": "7aa6bd9d6c51a86b",
        "name": "ğŸ” å®šæœŸå®‰å…¨æª¢æŸ¥ï¼ˆæ¯5åˆ†é˜ï¼‰",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "periodic_check",
        "payloadType": "str",
        "x": 150,
        "y": 80,
        "wires": [["periodic_checker"]]
    },
    {
        "id": "periodic_checker",
        "type": "function",
        "z": "7aa6bd9d6c51a86b",
        "name": "å®šæœŸæª¢æŸ¥å™¨",
        "func": "// ç²å–é›»æ± é…ç½®\nconst batteries = flow.get('batteries');\nif (!batteries) {\n    // å¦‚æœé…ç½®ä¸Ÿå¤±ï¼Œé‡æ–°è¼‰å…¥\n    const defaultBatteries = {\n        makita: {\n            entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_4',\n            name: 'ç‰§ç”°BL1041Bå……é›»é›»æ± ',\n            chargingTime: 90,\n            maxTime: 135,\n            domain: 'switch'\n        },\n        eneloop_aa: {\n            entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_5',\n            name: 'ENELOOP 3è™Ÿå……é›»é›»æ± ',\n            chargingTime: 240,\n            maxTime: 360,\n            domain: 'switch'\n        },\n        eneloop_aaa: {\n            entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_6',\n            name: 'ENELOOP 4è™Ÿå……é›»é›»æ± ',\n            chargingTime: 210,\n            maxTime: 315,\n            domain: 'switch'\n        }\n    };\n    flow.set('batteries', defaultBatteries);\n    \n    return {\n        payload: {\n            title: 'âš ï¸ é…ç½®é‡æ–°è¼‰å…¥',\n            message: 'âš ï¸ æª¢æ¸¬åˆ°é…ç½®ä¸Ÿå¤±ï¼Œå·²é‡æ–°è¼‰å…¥é›»æ± é…ç½®ã€‚\\n\\nå»ºè­°æª¢æŸ¥ç³»çµ±ç‹€æ…‹ã€‚'\n        },\n        action: 'config_reloaded'\n    };\n}\n\nconst now = Date.now();\nconst outputs = [null, null, null]; // [é€šçŸ¥, æ§åˆ¶, debug]\nlet warnings = [];\nlet emergencyStops = [];\nlet timerIssues = [];\n\n// æª¢æŸ¥æ¯å€‹é›»æ± çš„ç‹€æ…‹\nfor (const [key, battery] of Object.entries(batteries)) {\n    const chargingInfo = context.get(`${key}_charging`);\n    const timerId = flow.get(`${key}_timer`);\n    \n    if (chargingInfo && chargingInfo.startTime) {\n        const chargingMinutes = Math.round((now - chargingInfo.startTime) / 60000);\n        \n        // æª¢æŸ¥æ˜¯å¦è¶…éæœ€å¤§æ™‚é–“\n        if (chargingMinutes >= battery.maxTime) {\n            emergencyStops.push({\n                battery: battery,\n                key: key,\n                chargingMinutes: chargingMinutes,\n                maxTime: battery.maxTime\n            });\n        }\n        // æª¢æŸ¥æ˜¯å¦è¶…éæ­£å¸¸æ™‚é–“ä½†è¨ˆæ™‚å™¨ä¸Ÿå¤±\n        else if (chargingMinutes >= battery.chargingTime && !timerId) {\n            timerIssues.push({\n                battery: battery,\n                key: key,\n                chargingMinutes: chargingMinutes,\n                expectedTime: battery.chargingTime\n            });\n        }\n        // æª¢æŸ¥æ˜¯å¦æ¥è¿‘è­¦å‘Šæ™‚é–“\n        else if (chargingMinutes >= battery.chargingTime * 0.9) {\n            warnings.push({\n                battery: battery,\n                key: key,\n                chargingMinutes: chargingMinutes,\n                expectedTime: battery.chargingTime\n            });\n        }\n    }\n}\n\n// è™•ç†ç·Šæ€¥é—œé–‰\nif (emergencyStops.length > 0) {\n    const stopList = emergencyStops.map(item => \n        `â€¢ ${item.battery.name}: ${item.chargingMinutes}åˆ†é˜ (æœ€å¤§${item.maxTime}åˆ†é˜)`\n    ).join('\\n');\n    \n    outputs[0] = {\n        payload: {\n            title: 'ğŸš¨ ç·Šæ€¥é—œé–‰éåº¦å……é›»',\n            message: `ğŸš¨ æª¢æ¸¬åˆ°åš´é‡éåº¦å……é›»ï¼Œç«‹å³é—œé–‰ï¼š\\n${stopList}\\n\\nâš ï¸ è«‹æª¢æŸ¥é›»æ± å’Œå……é›»å™¨ç‹€æ…‹\\nğŸ• æª¢æŸ¥æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        action: 'periodic_emergency_stop'\n    };\n    \n    // é—œé–‰ç¬¬ä¸€å€‹éåº¦å……é›»çš„è¨­å‚™\n    const firstStop = emergencyStops[0];\n    outputs[1] = {\n        payload: {\n            domain: firstStop.battery.domain,\n            service: 'turn_off',\n            target: {\n                entity_id: firstStop.battery.entityId\n            }\n        },\n        batteryKey: firstStop.key,\n        action: 'periodic_emergency_stop'\n    };\n    \n    // æ¸…é™¤å……é›»è¨˜éŒ„\n    emergencyStops.forEach(item => {\n        context.set(`${item.key}_charging`, null);\n        const timerId = flow.get(`${item.key}_timer`);\n        if (timerId) {\n            clearTimeout(timerId);\n            flow.set(`${item.key}_timer`, null);\n        }\n    });\n}\n\n// è™•ç†è¨ˆæ™‚å™¨å•é¡Œ\nelse if (timerIssues.length > 0) {\n    const issueList = timerIssues.map(item => \n        `â€¢ ${item.battery.name}: ${item.chargingMinutes}åˆ†é˜ (è¨­å®š${item.expectedTime}åˆ†é˜)`\n    ).join('\\n');\n    \n    outputs[0] = {\n        payload: {\n            title: 'âš ï¸ è¨ˆæ™‚å™¨å¤±æ•ˆæª¢æ¸¬',\n            message: `âš ï¸ æª¢æ¸¬åˆ°è¨ˆæ™‚å™¨å¤±æ•ˆï¼Œç«‹å³é—œé–‰ï¼š\\n${issueList}\\n\\nğŸ”§ è¨ˆæ™‚å™¨å¯èƒ½å› é‡å•Ÿæˆ–éŒ¯èª¤è€Œå¤±æ•ˆ\\nğŸ• æª¢æŸ¥æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        action: 'timer_failure_stop'\n    };\n    \n    // é—œé–‰ç¬¬ä¸€å€‹æœ‰å•é¡Œçš„è¨­å‚™\n    const firstIssue = timerIssues[0];\n    outputs[1] = {\n        payload: {\n            domain: firstIssue.battery.domain,\n            service: 'turn_off',\n            target: {\n                entity_id: firstIssue.battery.entityId\n            }\n        },\n        batteryKey: firstIssue.key,\n        action: 'timer_failure_stop'\n    };\n    \n    // æ¸…é™¤å……é›»è¨˜éŒ„\n    timerIssues.forEach(item => {\n        context.set(`${item.key}_charging`, null);\n    });\n}\n\n// è™•ç†è­¦å‘Š\nelse if (warnings.length > 0) {\n    const warnList = warnings.map(item => \n        `â€¢ ${item.battery.name}: ${item.chargingMinutes}åˆ†é˜ (è¨­å®š${item.expectedTime}åˆ†é˜)`\n    ).join('\\n');\n    \n    outputs[0] = {\n        payload: {\n            title: 'â° å……é›»å³å°‡å®Œæˆ',\n            message: `â° ä»¥ä¸‹é›»æ± å³å°‡å®Œæˆå……é›»ï¼š\\n${warnList}\\n\\né è¨ˆå¾ˆå¿«æœƒè‡ªå‹•é—œé–‰\\nğŸ• æª¢æŸ¥æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        action: 'charging_warning'\n    };\n}\n\n// Debugè¼¸å‡º\noutputs[2] = {\n    payload: 'å®šæœŸæª¢æŸ¥å®Œæˆ',\n    warnings: warnings.length,\n    emergencyStops: emergencyStops.length,\n    timerIssues: timerIssues.length,\n    checkTime: new Date().toISOString()\n};\n\nnode.status({\n    fill: emergencyStops.length > 0 ? \"red\" : timerIssues.length > 0 ? \"orange\" : warnings.length > 0 ? \"yellow\" : \"green\",\n    shape: \"dot\",\n    text: `æª¢æŸ¥: ${warnings.length}è­¦å‘Š, ${timerIssues.length}è¨ˆæ™‚å™¨å•é¡Œ, ${emergencyStops.length}ç·Šæ€¥`\n});\n\nreturn outputs;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 80,
        "wires": [["d320c63adb96c9b2"], ["57a17fab27364441"], ["debug_periodic"]]
    },
    {
        "id": "emergency_stop_all",
        "type": "inject",
        "z": "7aa6bd9d6c51a86b",
        "name": "ğŸš¨ ç·Šæ€¥é—œé–‰æ‰€æœ‰å……é›»",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "emergency_stop",
        "payloadType": "str",
        "x": 130,
        "y": 140,
        "wires": [["emergency_handler"]]
    },
    {
        "id": "emergency_handler",
        "type": "function",
        "z": "7aa6bd9d6c51a86b",
        "name": "ç·Šæ€¥è™•ç†å™¨",
        "func": "// é›»æ± é…ç½®\nconst batteries = {\n    makita: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_4',\n        name: 'ç‰§ç”°BL1041Bå……é›»é›»æ± ',\n        domain: 'switch'\n    },\n    eneloop_aa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_5',\n        name: 'ENELOOP 3è™Ÿå……é›»é›»æ± ',\n        domain: 'switch'\n    },\n    eneloop_aaa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_6',\n        name: 'ENELOOP 4è™Ÿå……é›»é›»æ± ',\n        domain: 'switch'\n    }\n};\n\n// æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨å’Œè¨˜éŒ„\nfor (const key of Object.keys(batteries)) {\n    // æ¸…é™¤è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${key}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n        flow.set(`${key}_timer`, null);\n    }\n    \n    // æ¸…é™¤å……é›»è¨˜éŒ„\n    context.set(`${key}_charging`, null);\n}\n\n// æº–å‚™ç·Šæ€¥é€šçŸ¥\nconst notifyMsg = {\n    payload: {\n        title: 'ğŸš¨ ç·Šæ€¥é—œé–‰å……é›»',\n        message: `ğŸš¨ å·²åŸ·è¡Œç·Šæ€¥é—œé–‰æ‰€æœ‰å……é›»è¨­å‚™\\n\\né—œé–‰è¨­å‚™ï¼š\\nâ€¢ ç‰§ç”°BL1041Bå……é›»é›»æ± \\nâ€¢ ENELOOP 3è™Ÿå……é›»é›»æ± \\nâ€¢ ENELOOP 4è™Ÿå……é›»é›»æ± \\n\\nâ° åŸ·è¡Œæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\\n\\nè«‹æª¢æŸ¥è¨­å‚™ç‹€æ…‹å’Œé›»æ± æº«åº¦ã€‚`\n    },\n    action: 'emergency_stop'\n};\n\n// æº–å‚™é—œé–‰å‘½ä»¤\nconst outputs = [notifyMsg];\n\nfor (const [key, battery] of Object.entries(batteries)) {\n    outputs.push({\n        payload: {\n            domain: battery.domain,\n            service: 'turn_off',\n            target: {\n                entity_id: battery.entityId\n            }\n        },\n        batteryKey: key,\n        action: 'emergency_stop'\n    });\n}\n\nnode.status({fill:\"red\", shape:\"dot\", text:\"ç·Šæ€¥é—œé–‰åŸ·è¡Œ\"});\n\nreturn outputs;",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 140,
        "wires": [["d320c63adb96c9b2"], ["57a17fab27364441"], ["57a17fab27364441"], ["57a17fab27364441"]]
    },
    {
        "id": "enhanced_charging_handler",
        "type": "function",
        "z": "7aa6bd9d6c51a86b",
        "name": "å¢å¼·å……é›»è™•ç†å™¨",
        "func": "// ç²å–é…ç½®\nconst batteries = flow.get('batteries');\nif (!batteries) {\n    node.error('ç³»çµ±æœªåˆå§‹åŒ–ï¼Œè«‹ç­‰å¾…ç³»çµ±å•Ÿå‹•å®Œæˆ');\n    return null;\n}\n\n// è§£æç‹€æ…‹è®ŠåŒ–\nconst newState = msg.payload;\nconst oldState = msg.data.old_state?.state;\nconst entityId = msg.data.entity_id;\n\n// æ‰¾åˆ°å°æ‡‰çš„é›»æ± \nlet batteryKey = null;\nlet battery = null;\n\nfor (const [key, config] of Object.entries(batteries)) {\n    if (config.entityId === entityId) {\n        batteryKey = key;\n        battery = config;\n        break;\n    }\n}\n\nif (!battery) {\n    node.error(`æ‰¾ä¸åˆ°å¯¦é«” ${entityId} çš„é…ç½®`);\n    return null;\n}\n\nconst outputs = [null, null, null]; // [é€šçŸ¥, æ§åˆ¶, debug]\n\n// æª¢æŸ¥é–‹å•Ÿç‹€æ…‹ (off -> on)\nif (oldState === 'off' && newState === 'on') {\n    // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${batteryKey}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n    }\n    \n    const startTime = Date.now();\n    \n    // ä½¿ç”¨contextå­˜å„²å……é›»ä¿¡æ¯ï¼ˆæŒä¹…åŒ–ï¼Œé‡å•Ÿå¾Œä»æœ‰æ•ˆï¼‰\n    context.set(`${batteryKey}_charging`, {\n        startTime: startTime,\n        entityId: entityId,\n        batteryName: battery.name,\n        expectedTime: battery.chargingTime,\n        maxTime: battery.maxTime || Math.round(battery.chargingTime * 1.5)\n    });\n    \n    // æ›´æ–°å……é›»è¨˜éŒ„\n    const records = flow.get('chargingRecords') || {};\n    if (!records[batteryKey]) records[batteryKey] = {};\n    records[batteryKey].lastCharge = new Date(startTime).toISOString();\n    records[batteryKey].count = (records[batteryKey].count || 0) + 1;\n    flow.set('chargingRecords', records);\n    \n    // è¨­å®šä¸»è¨ˆæ™‚å™¨\n    const chargingMs = battery.chargingTime * 60 * 1000;\n    const newTimerId = setTimeout(() => {\n        // ä¸»è¨ˆæ™‚å™¨åˆ°æœŸï¼Œæ­£å¸¸é—œé–‰\n        const controlMsg = {\n            payload: {\n                domain: battery.domain,\n                service: 'turn_off',\n                target: {\n                    entity_id: entityId\n                }\n            },\n            batteryKey: batteryKey,\n            action: 'normal_stop'\n        };\n        \n        // æ¸…é™¤å……é›»è¨˜éŒ„\n        context.set(`${batteryKey}_charging`, null);\n        \n        node.send([null, controlMsg, {\n            payload: `æ­£å¸¸é—œé–‰ ${battery.name}`,\n            batteryKey: batteryKey,\n            action: 'normal_stop'\n        }]);\n        \n        flow.set(`${batteryKey}_timer`, null);\n    }, chargingMs);\n    \n    flow.set(`${batteryKey}_timer`, newTimerId);\n    \n    // æº–å‚™é–‹å§‹é€šçŸ¥\n    const notifyMsg = {\n        payload: {\n            title: 'ğŸ”‹ å……é›»é–‹å§‹',\n            message: `ğŸ”‹ ${battery.name} é–‹å§‹å……é›»\\nâ±ï¸ é è¨ˆæ™‚é–“ï¼š${battery.chargingTime}åˆ†é˜\\nğŸ›¡ï¸ å®‰å…¨é™åˆ¶ï¼š${battery.maxTime || Math.round(battery.chargingTime * 1.5)}åˆ†é˜\\nğŸ”„ é‡å•Ÿä¿è­·ï¼šå·²å•Ÿç”¨\\nğŸ• é–‹å§‹æ™‚é–“ï¼š${new Date(startTime).toLocaleString('zh-TW')}`\n        },\n        batteryKey: batteryKey,\n        action: 'start'\n    };\n    \n    outputs[0] = notifyMsg;\n    outputs[2] = {\n        payload: `${battery.name} é–‹å§‹å……é›»ï¼ˆé‡å•Ÿå®‰å…¨ä¿è­·ï¼‰`,\n        batteryKey: batteryKey,\n        chargingTime: battery.chargingTime,\n        maxTime: battery.maxTime,\n        startTime: startTime,\n        persistentRecord: true\n    };\n}\n\n// æª¢æŸ¥é—œé–‰ç‹€æ…‹ (on -> off)\nelse if (newState === 'off' && oldState === 'on') {\n    // æ¸…é™¤è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${batteryKey}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n        flow.set(`${batteryKey}_timer`, null);\n    }\n    \n    // ç²å–å……é›»ä¿¡æ¯\n    const chargingInfo = context.get(`${batteryKey}_charging`);\n    let actualTime = 0;\n    let startTime = null;\n    \n    if (chargingInfo && chargingInfo.startTime) {\n        actualTime = Math.round((Date.now() - chargingInfo.startTime) / 60000);\n        startTime = new Date(chargingInfo.startTime);\n        context.set(`${batteryKey}_charging`, null); // æ¸…é™¤å……é›»è¨˜éŒ„\n    }\n    \n    // åˆ¤æ–·é—œé–‰åŸå› \n    let stopReason = 'æ‰‹å‹•é—œé–‰';\n    let statusIcon = 'âœ…';\n    let efficiency = 100;\n    \n    if (actualTime > battery.chargingTime * 1.2) {\n        stopReason = 'å»¶é²é—œé–‰ï¼ˆå¯èƒ½è¨ˆæ™‚å™¨å¤±æ•ˆï¼‰';\n        statusIcon = 'âš ï¸';\n        efficiency = Math.round((battery.chargingTime / actualTime) * 100);\n    } else if (actualTime > 0) {\n        efficiency = Math.round((battery.chargingTime / actualTime) * 100);\n    }\n    \n    const notifyMsg = {\n        payload: {\n            title: `${statusIcon} å……é›»å®Œæˆ`,\n            message: `${statusIcon} ${battery.name} å……é›»å®Œæˆ\\nâ±ï¸ å……é›»æ™‚é•·ï¼š${actualTime}åˆ†é˜\\nğŸ“‹ è¨­å®šæ™‚é–“ï¼š${battery.chargingTime}åˆ†é˜\\nğŸ“Š æ™‚é–“æ•ˆç‡ï¼š${efficiency}%\\nğŸ• å®Œæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\\n${startTime ? `\\nğŸ• é–‹å§‹æ™‚é–“ï¼š${startTime.toLocaleString('zh-TW')}` : ''}\\n\\n${stopReason}`\n        },\n        batteryKey: batteryKey,\n        action: 'complete'\n    };\n    \n    outputs[0] = notifyMsg;\n    outputs[2] = {\n        payload: `${battery.name} å……é›»å®Œæˆ`,\n        batteryKey: batteryKey,\n        actualTime: actualTime,\n        expectedTime: battery.chargingTime,\n        efficiency: efficiency,\n        stopReason: stopReason\n    };\n}\n\nreturn outputs;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 280,
        "wires": [["d320c63adb96c9b2"], ["57a17fab27364441"], ["debug_charging"]]
    },
    {
        "id": "125d83f7.1a33dc",
        "type": "server",
        "name": "Home Assistant",
        "addon": true
    }
]
