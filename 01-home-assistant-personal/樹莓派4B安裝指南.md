# ğŸ“ æ¨¹è“æ´¾4B - æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ±å®‰è£æŒ‡å—

## ğŸ“‹ ç³»çµ±ç’°å¢ƒç¢ºèª

### ğŸ” æª¢æŸ¥æ‚¨çš„æ¨¹è“æ´¾4Bç’°å¢ƒ

åœ¨é–‹å§‹å®‰è£å‰ï¼Œè«‹ç¢ºèªæ‚¨çš„ç’°å¢ƒï¼š

```bash
# æª¢æŸ¥ç³»çµ±ç‰ˆæœ¬
cat /etc/os-release

# æª¢æŸ¥Home Assistantç‹€æ…‹
sudo systemctl status home-assistant@homeassistant
# æˆ–è€… (å¦‚æœä½¿ç”¨Home Assistant OS)
ha core info

# æª¢æŸ¥Node-REDç‹€æ…‹
sudo systemctl status nodered
# æˆ–è€…
ps aux | grep node-red
```

### ğŸ“ å¸¸è¦‹çš„Home Assistanté…ç½®ç›®éŒ„

æ ¹æ“šæ‚¨çš„å®‰è£æ–¹å¼ï¼Œé…ç½®ç›®éŒ„å¯èƒ½åœ¨ï¼š

| å®‰è£æ–¹å¼ | é…ç½®ç›®éŒ„è·¯å¾‘ |
|---------|-------------|
| Home Assistant OS | `/config` |
| Home Assistant Supervised | `/usr/share/hassio/homeassistant` |
| Home Assistant Core (venv) | `/home/homeassistant/.homeassistant` |
| Home Assistant Core (Docker) | `/opt/homeassistant/.homeassistant` |
| æ‰‹å‹•å®‰è£ | `~/.homeassistant` |

---

## ğŸš€ æ­¥é©Ÿ1ï¼šæ›´æ–°Node-RED Home Assistantç¯€é»

### æª¢æŸ¥ç•¶å‰ç‰ˆæœ¬

```bash
# é€²å…¥Node-REDç›®éŒ„
cd ~/.node-red

# æª¢æŸ¥å·²å®‰è£çš„Home Assistantç¯€é»ç‰ˆæœ¬
npm list node-red-contrib-home-assistant-websocket
```

### æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

```bash
# æ›´æ–°Home Assistantç¯€é» (è§£æ±ºcall-serviceå•é¡Œ)
npm update node-red-contrib-home-assistant-websocket

# æˆ–è€…é‡æ–°å®‰è£
npm uninstall node-red-contrib-home-assistant-websocket
npm install node-red-contrib-home-assistant-websocket@latest

# é‡å•ŸNode-RED
sudo systemctl restart nodered
```

### ğŸ”§ å¦‚æœé‡åˆ°æ¬Šé™å•é¡Œ

```bash
# ä¿®æ”¹Node-REDç›®éŒ„æ¬Šé™
sudo chown -R pi:pi ~/.node-red

# æˆ–è€…ä½¿ç”¨sudoå®‰è£ (ä¸æ¨è–¦ï¼Œä½†æœ‰æ™‚å¿…è¦)
sudo npm install -g --unsafe-perm node-red-contrib-home-assistant-websocket
```

---

## ğŸš€ æ­¥é©Ÿ2ï¼šå®‰è£Home Assistantè¼”åŠ©å¯¦é«”

### æ–¹æ³•ä¸€ï¼šè‡ªå‹•æª¢æ¸¬é…ç½®ç›®éŒ„

```bash
# ä½¿ç”¨æˆ‘å€‘çš„å®‰è£è…³æœ¬
chmod +x install-battery-management.sh
./install-battery-management.sh
```

### æ–¹æ³•äºŒï¼šæ‰‹å‹•å®‰è£

1. **æ‰¾åˆ°æ‚¨çš„é…ç½®ç›®éŒ„**
   ```bash
   # æª¢æŸ¥å¯èƒ½çš„é…ç½®ç›®éŒ„
   ls -la /config 2>/dev/null && echo "æ‰¾åˆ° /config"
   ls -la /usr/share/hassio/homeassistant 2>/dev/null && echo "æ‰¾åˆ° Supervised ç›®éŒ„"
   ls -la ~/.homeassistant 2>/dev/null && echo "æ‰¾åˆ°ç”¨æˆ¶ç›®éŒ„"
   ```

2. **å‰µå»ºpackagesç›®éŒ„**
   ```bash
   # æ›¿æ› CONFIG_DIR ç‚ºæ‚¨çš„å¯¦éš›é…ç½®ç›®éŒ„
   CONFIG_DIR="/config"  # æˆ–æ‚¨æ‰¾åˆ°çš„å¯¦éš›è·¯å¾‘
   
   mkdir -p $CONFIG_DIR/packages
   ```

3. **è¤‡è£½é…ç½®æ–‡ä»¶**
   ```bash
   # è¤‡è£½è¼”åŠ©å¯¦é«”é…ç½®
   cp battery-helpers.yaml $CONFIG_DIR/packages/
   ```

4. **ä¿®æ”¹configuration.yaml**
   ```bash
   # æª¢æŸ¥æ˜¯å¦å·²æœ‰packagesé…ç½®
   grep -q "packages:" $CONFIG_DIR/configuration.yaml
   
   # å¦‚æœæ²’æœ‰ï¼Œæ·»åŠ packagesé…ç½®
   if [ $? -ne 0 ]; then
       echo "" >> $CONFIG_DIR/configuration.yaml
       echo "# æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ±" >> $CONFIG_DIR/configuration.yaml
       echo "homeassistant:" >> $CONFIG_DIR/configuration.yaml
       echo "  packages: !include_dir_named packages/" >> $CONFIG_DIR/configuration.yaml
   fi
   ```

5. **é‡å•ŸHome Assistant**
   ```bash
   # æ ¹æ“šæ‚¨çš„å®‰è£æ–¹å¼é¸æ“‡
   sudo systemctl restart home-assistant@homeassistant
   # æˆ–
   ha core restart
   ```

---

## ğŸš€ æ­¥é©Ÿ3ï¼šå°å…¥Node-REDæµç¨‹

### 1. æ‰“é–‹Node-REDç·¨è¼¯å™¨

```
http://æ¨¹è“æ´¾IP:1880
```

### 2. å°å…¥ä¿®æ­£å¾Œçš„æµç¨‹

1. é»æ“Šå³ä¸Šè§’é¸å–® â†’ å°å…¥
2. é¸æ“‡æ›´æ–°å¾Œçš„ `battery-charging-flow.json` æ–‡ä»¶
3. é»æ“Šã€Œå°å…¥ã€

**é‡è¦**ï¼šæ–°ç‰ˆæœ¬ä½¿ç”¨ `api-call-service` ç¯€é»é¡å‹ï¼Œå·²ä¿®æ­£ç›¸å®¹æ€§å•é¡Œã€‚

### 3. é…ç½®Home Assistanté€£æ¥

1. é›™æ“Šä»»ä¸€å€‹ç›£æ§ç¯€é»
2. é»æ“Šã€ŒServerã€æ—çš„ç·¨è¼¯æŒ‰éˆ•
3. é…ç½®é€£æ¥è³‡è¨Šï¼š
   - **Name**: `Home Assistant`
   - **Base URL**: `http://localhost:8123` (åŒå°æ¨¹è“æ´¾)
   - **Access Token**: å¾HAç”¨æˆ¶è¨­å®šä¸­ç”Ÿæˆé•·æœŸå­˜å–æ¬Šæ–

### 4. è¼‰å…¥é…ç½®æ–‡ä»¶

1. **è¤‡è£½é…ç½®æ–‡ä»¶åˆ°Node-REDç›®éŒ„**
   ```bash
   cp battery-config.js ~/.node-red/
   ```

2. **æ·»åŠ é…ç½®è¼‰å…¥ç¯€é»**
   
   åœ¨Node-REDä¸­æ·»åŠ ï¼š
   - **Injectç¯€é»** (è¨­å®šç‚ºå•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡)
   - **Functionç¯€é»** (è¼‰å…¥é…ç½®)
   
   Functionç¯€é»ä»£ç¢¼ï¼š
   ```javascript
   // è¼‰å…¥é›»æ± å……é›»é…ç½®
   try {
       const config = require('./battery-config.js');
       global.set('batteryChargingConfig', config);
       node.status({fill:"green", shape:"dot", text:"é…ç½®å·²è¼‰å…¥"});
       msg.payload = "é›»æ± å……é›»é…ç½®å·²æˆåŠŸè¼‰å…¥";
   } catch (error) {
       node.status({fill:"red", shape:"ring", text:"é…ç½®è¼‰å…¥å¤±æ•—"});
       msg.payload = "é…ç½®è¼‰å…¥å¤±æ•—: " + error.message;
       node.error(error);
   }
   return msg;
   ```

3. **éƒ¨ç½²ä¸¦æ¸¬è©¦**
   - é»æ“Šã€ŒDeployã€
   - é»æ“Šinjectç¯€é»æ¸¬è©¦é…ç½®è¼‰å…¥
   - æª¢æŸ¥debugè¼¸å‡ºç¢ºèªé…ç½®æˆåŠŸ

---

## ğŸ”§ æ¨¹è“æ´¾4Bç‰¹æ®Šè¨­å®š

### ğŸ“± é€šçŸ¥æœå‹™é…ç½®

ç·¨è¼¯ `battery-config.js` ä¸­çš„é€šçŸ¥è¨­å®šï¼Œæ ¹æ“šæ‚¨çš„æ¨¹è“æ´¾ç’°å¢ƒèª¿æ•´ï¼š

```javascript
const notificationConfig = {
    notifyHelper: {
        enabled: true,
        service: 'notify.notify',  // æˆ– 'notify.mobile_app_your_phone'
        targets: ['person.ming'], // æ”¹ç‚ºæ‚¨çš„personå¯¦é«”
        priority: 'normal'
    },
    synologyChat: {
        enabled: true,
        service: 'notify.synology_chat_bot_3', // æ‚¨çš„å¯¦éš›æœå‹™åç¨±
        username: 'Battery Manager',
        channel: '#smart-home'
    },
    telegram: {
        enabled: true,
        service: 'notify.telegram', // æ‚¨çš„å¯¦éš›æœå‹™åç¨±
        parseMode: 'HTML'
    }
};
```

### ğŸ• æ™‚å€è¨­å®š

ç¢ºä¿æ¨¹è“æ´¾æ™‚å€æ­£ç¢ºï¼š

```bash
# æª¢æŸ¥ç•¶å‰æ™‚å€
timedatectl

# è¨­å®šå°åŒ—æ™‚å€
sudo timedatectl set-timezone Asia/Taipei

# åŒæ­¥æ™‚é–“
sudo systemctl restart systemd-timesyncd
```

### ğŸ’¾ SDå¡å„ªåŒ– (å¯é¸)

ç‚ºäº†æ¸›å°‘SDå¡å¯«å…¥ï¼Œå¯ä»¥èª¿æ•´æ—¥èªŒè¨­å®šï¼š

```bash
# ç·¨è¼¯Node-REDè¨­å®š
nano ~/.node-red/settings.js

# åœ¨settings.jsä¸­æ·»åŠ æˆ–ä¿®æ”¹ï¼š
logging: {
    console: {
        level: "info",
        metrics: false,
        audit: false
    }
}
```

---

## âœ… é©—è­‰å®‰è£

### 1. æª¢æŸ¥Home Assistantå¯¦é«”

åœ¨Home Assistantä¸­ç¢ºèªæ–°å¢çš„å¯¦é«”ï¼š

```
è¨­å®š â†’ è£ç½®èˆ‡æœå‹™ â†’ å¯¦é«”
```

æœå°‹ `battery` æ‡‰è©²çœ‹åˆ°ï¼š
- `input_boolean.battery_management_enabled`
- `input_number.makita_charging_time`
- `sensor.makita_days_since_charge`
- ç­‰ç­‰...

### 2. æ¸¬è©¦Node-REDæµç¨‹

1. åœ¨Node-REDä¸­æª¢æŸ¥æ‰€æœ‰ç¯€é»éƒ½æ˜¯ç¶ è‰²é€£æ¥ç‹€æ…‹
2. æ‰‹å‹•è§¸ç™¼injectç¯€é»æ¸¬è©¦é…ç½®è¼‰å…¥
3. æª¢æŸ¥debugè¼¸å‡ºç¢ºèªç„¡éŒ¯èª¤

### 3. æ¸¬è©¦å……é›»åŠŸèƒ½

1. **æ‰‹å‹•æ¸¬è©¦**ï¼š
   - æ‰‹å‹•é–‹å•Ÿä»»ä¸€å……é›»æ’åº§
   - æª¢æŸ¥æ˜¯å¦æ”¶åˆ°å……é›»é–‹å§‹é€šçŸ¥
   - ç­‰å¾…å¹¾åˆ†é˜å¾Œæ‰‹å‹•é—œé–‰
   - æª¢æŸ¥æ˜¯å¦æ”¶åˆ°å……é›»å®Œæˆé€šçŸ¥

2. **æª¢æŸ¥ç‹€æ…‹**ï¼š
   - åœ¨Home Assistantä¸­æŸ¥çœ‹é›»æ± ç‹€æ…‹æ„Ÿæ¸¬å™¨
   - ç¢ºèªä¸Šæ¬¡å……é›»æ™‚é–“å·²æ›´æ–°

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### âŒ Node-REDç¯€é»é¡¯ç¤ºunknown

**åŸå› **ï¼šNode-RED Home Assistantç¯€é»ç‰ˆæœ¬éèˆŠ

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# æ›´æ–°ç¯€é»
cd ~/.node-red
npm update node-red-contrib-home-assistant-websocket
sudo systemctl restart nodered
```

### âŒ Home Assistanté€£æ¥å¤±æ•—

**æª¢æŸ¥é …ç›®**ï¼š
1. Home Assistantæ˜¯å¦æ­£åœ¨é‹è¡Œ
2. å­˜å–æ¬Šæ–æ˜¯å¦æ­£ç¢º
3. ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# æª¢æŸ¥Home Assistantç‹€æ…‹
sudo systemctl status home-assistant@homeassistant

# æª¢æŸ¥ç¶²è·¯é€£æ¥
curl http://localhost:8123

# é‡æ–°ç”Ÿæˆå­˜å–æ¬Šæ–
# åœ¨HAä¸­ï¼šç”¨æˆ¶è¨­å®š â†’ å®‰å…¨æ€§ â†’ é•·æœŸå­˜å–æ¬Šæ–
```

### âŒ é…ç½®æ–‡ä»¶è¼‰å…¥å¤±æ•—

**æª¢æŸ¥é …ç›®**ï¼š
1. æ–‡ä»¶è·¯å¾‘æ˜¯å¦æ­£ç¢º
2. æ–‡ä»¶æ¬Šé™æ˜¯å¦æ­£ç¢º
3. JavaScriptèªæ³•æ˜¯å¦æ­£ç¢º

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# æª¢æŸ¥æ–‡ä»¶æ¬Šé™
ls -la ~/.node-red/battery-config.js

# ä¿®æ­£æ¬Šé™
chmod 644 ~/.node-red/battery-config.js

# æª¢æŸ¥èªæ³•
node -c ~/.node-red/battery-config.js
```

### âŒ é€šçŸ¥æœªç™¼é€

**æª¢æŸ¥é …ç›®**ï¼š
1. é€šçŸ¥æœå‹™æ˜¯å¦æ­£ç¢ºé…ç½®
2. æ˜¯å¦åœ¨éœéŸ³æ™‚é–“å…§
3. å¯¦é«”IDæ˜¯å¦æ­£ç¢º

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. åœ¨Home Assistantä¸­æ¸¬è©¦é€šçŸ¥æœå‹™
2. æª¢æŸ¥Node-RED debugè¼¸å‡º
3. ç¢ºèªé€šçŸ¥æœå‹™åç¨±æ­£ç¢º

---

## ğŸ“ æ¨¹è“æ´¾4Bå°ˆç”¨æ”¯æ´

### ğŸ” ç³»çµ±è³‡è¨Šæ”¶é›†

å¦‚æœéœ€è¦æŠ€è¡“æ”¯æ´ï¼Œè«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼š

```bash
# ç³»çµ±è³‡è¨Š
uname -a
cat /etc/os-release

# Home Assistantç‰ˆæœ¬
ha core info
# æˆ–
grep "version" /config/.HA_VERSION

# Node-REDç‰ˆæœ¬
node-red --version

# å·²å®‰è£çš„HAç¯€é»ç‰ˆæœ¬
cd ~/.node-red && npm list node-red-contrib-home-assistant-websocket
```

### ğŸ“Š æ•ˆèƒ½ç›£æ§

```bash
# æª¢æŸ¥ç³»çµ±è³‡æºä½¿ç”¨
htop

# æª¢æŸ¥SDå¡ä½¿ç”¨æƒ…æ³
df -h

# æª¢æŸ¥è¨˜æ†¶é«”ä½¿ç”¨
free -h
```

---

## ğŸ‰ å®Œæˆï¼

æ‚¨çš„æ¨¹è“æ´¾4Bæ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ±ç¾åœ¨å·²ç¶“æº–å‚™å°±ç·’ï¼

**ä¸‹ä¸€æ­¥**ï¼š
1. æ¸¬è©¦æ‰€æœ‰å……é›»æ’åº§åŠŸèƒ½
2. èª¿æ•´å……é›»æ™‚é–“åƒæ•¸
3. è¨­å®šå€‹äººåŒ–é€šçŸ¥
4. äº«å—æ™ºèƒ½å……é›»ç®¡ç†ï¼

å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹åƒè€ƒæ•…éšœæ’é™¤ç« ç¯€æˆ–æª¢æŸ¥ç³»çµ±æ—¥èªŒã€‚
