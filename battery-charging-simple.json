[
    {
        "id": "battery_simple_tab",
        "type": "tab",
        "label": "æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - ç°¡åŒ–ç‰ˆ",
        "disabled": false,
        "info": "ç´”Node-REDå¯¦ç¾çš„æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ±\n\nåŠŸèƒ½ï¼š\n1. æ‰‹å‹•å……é›»è‡ªå‹•è¨ˆæ™‚é—œé–‰\n2. å®šæœŸç¶­è­·å……é›»\n3. å¤šé‡é€šçŸ¥ç³»çµ±\n4. å®Œæ•´çš„debugè¼¸å‡º\n\næ”¯æ´é›»æ± ï¼š\n- ç‰§ç”°BL1041B (media_player.volume_set)\n- ENELOOP 3è™Ÿ (switch.tp_link_power_strip_eb2f_cha_shang_5)\n- ENELOOP 4è™Ÿ (switch.tp_link_power_strip_eb2f_cha_shang_6)\n\nç„¡éœ€yamlæ–‡ä»¶ï¼Œç´”Node-REDå¯¦ç¾",
        "env": []
    },
    {
        "id": "init_config",
        "type": "inject",
        "z": "battery_simple_tab",
        "name": "åˆå§‹åŒ–é…ç½®",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 2,
        "topic": "",
        "payload": "init",
        "payloadType": "str",
        "x": 120,
        "y": 60,
        "wires": [["config_setup"]]
    },
    {
        "id": "config_setup",
        "type": "function",
        "z": "battery_simple_tab",
        "name": "é…ç½®è¨­å®š",
        "func": "// é›»æ± é…ç½®\nconst batteryConfig = {\n    makita: {\n        entityId: 'media_player.volume_set',\n        name: 'ç‰§ç”°BL1041Bå……é›»é›»æ± ',\n        chargingTime: 90, // åˆ†é˜\n        maintenanceDays: 30,\n        maxTime: 180\n    },\n    eneloop_aa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_5',\n        name: 'ENELOOP 3è™Ÿå……é›»é›»æ± ',\n        chargingTime: 240, // åˆ†é˜\n        maintenanceDays: 60,\n        maxTime: 360\n    },\n    eneloop_aaa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_6',\n        name: 'ENELOOP 4è™Ÿå……é›»é›»æ± ',\n        chargingTime: 210, // åˆ†é˜\n        maintenanceDays: 60,\n        maxTime: 300\n    }\n};\n\n// é€šçŸ¥é…ç½®\nconst notifyConfig = {\n    services: [\n        'notify.notify',\n        'notify.synology_chat_bot_3',\n        'notify.telegram'\n    ],\n    enabled: true\n};\n\n// å„²å­˜åˆ°context\nflow.set('batteryConfig', batteryConfig);\nflow.set('notifyConfig', notifyConfig);\n\n// åˆå§‹åŒ–å……é›»è¨˜éŒ„\nconst chargingRecords = flow.get('chargingRecords') || {};\nObject.keys(batteryConfig).forEach(key => {\n    if (!chargingRecords[key]) {\n        chargingRecords[key] = {\n            lastCharge: null,\n            chargingCount: 0\n        };\n    }\n});\nflow.set('chargingRecords', chargingRecords);\n\nmsg.payload = {\n    status: 'initialized',\n    config: batteryConfig,\n    notify: notifyConfig\n};\n\nnode.status({fill:\"green\", shape:\"dot\", text:\"é…ç½®å·²è¼‰å…¥\"});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 60,
        "wires": [["debug_config"]]
    },
    {
        "id": "debug_config",
        "type": "debug",
        "z": "battery_simple_tab",
        "name": "é…ç½®Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 500,
        "y": 60,
        "wires": []
    },
    {
        "id": "makita_monitor",
        "type": "server-state-changed",
        "z": "battery_simple_tab",
        "name": "ç‰§ç”°é›»æ± ç›£æ§",
        "server": "home_assistant_server",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": ["media_player.volume_set"],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            }
        ],
        "x": 120,
        "y": 140,
        "wires": [["battery_logic"]]
    },
    {
        "id": "eneloop_aa_monitor",
        "type": "server-state-changed",
        "z": "battery_simple_tab",
        "name": "ENELOOP 3è™Ÿç›£æ§",
        "server": "home_assistant_server",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": ["switch.tp_link_power_strip_eb2f_cha_shang_5"],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            }
        ],
        "x": 120,
        "y": 200,
        "wires": [["battery_logic"]]
    },
    {
        "id": "eneloop_aaa_monitor",
        "type": "server-state-changed",
        "z": "battery_simple_tab",
        "name": "ENELOOP 4è™Ÿç›£æ§",
        "server": "home_assistant_server",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": ["switch.tp_link_power_strip_eb2f_cha_shang_6"],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            }
        ],
        "x": 120,
        "y": 260,
        "wires": [["battery_logic"]]
    },
    {
        "id": "battery_logic",
        "type": "function",
        "z": "battery_simple_tab",
        "name": "é›»æ± å……é›»é‚è¼¯",
        "func": "// ç²å–é…ç½®\nconst batteryConfig = flow.get('batteryConfig');\nconst notifyConfig = flow.get('notifyConfig');\n\nif (!batteryConfig || !notifyConfig) {\n    node.error('é…ç½®æœªè¼‰å…¥ï¼Œè«‹å…ˆåŸ·è¡Œåˆå§‹åŒ–');\n    return null;\n}\n\n// è§£æç‹€æ…‹è®ŠåŒ–\nconst newState = msg.payload;\nconst oldState = msg.data.old_state?.state;\nconst entityId = msg.data.entity_id;\n\n// æ‰¾åˆ°å°æ‡‰çš„é›»æ± é…ç½®\nlet batteryKey = null;\nlet battery = null;\n\nfor (const [key, config] of Object.entries(batteryConfig)) {\n    if (config.entityId === entityId) {\n        batteryKey = key;\n        battery = config;\n        break;\n    }\n}\n\nif (!battery) {\n    node.error(`æ‰¾ä¸åˆ°å¯¦é«” ${entityId} çš„é…ç½®`);\n    return null;\n}\n\n// æº–å‚™è¼¸å‡ºè¨Šæ¯\nconst messages = [null, null, null]; // [é€šçŸ¥, æ§åˆ¶, debug]\n\n// æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹å‹•é–‹å•Ÿ (å¾offè®Šç‚ºon)\nif (oldState === 'off' && newState === 'on') {\n    // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${batteryKey}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n        flow.set(`${batteryKey}_timer`, null);\n    }\n    \n    // è¨˜éŒ„å……é›»é–‹å§‹æ™‚é–“\n    const startTime = new Date();\n    flow.set(`${batteryKey}_start`, startTime.getTime());\n    \n    // æ›´æ–°å……é›»è¨˜éŒ„\n    const records = flow.get('chargingRecords') || {};\n    if (!records[batteryKey]) records[batteryKey] = {};\n    records[batteryKey].lastCharge = startTime.toISOString();\n    records[batteryKey].chargingCount = (records[batteryKey].chargingCount || 0) + 1;\n    flow.set('chargingRecords', records);\n    \n    // è¨­å®šè‡ªå‹•é—œé–‰è¨ˆæ™‚å™¨\n    const chargingTimeMs = battery.chargingTime * 60 * 1000;\n    const newTimerId = setTimeout(() => {\n        // è‡ªå‹•é—œé–‰æ’åº§\n        const domain = entityId.includes('switch') ? 'switch' : 'media_player';\n        const service = 'turn_off';\n        \n        const controlMsg = {\n            payload: {\n                domain: domain,\n                service: service,\n                target: {\n                    entity_id: entityId\n                }\n            },\n            topic: 'auto_stop',\n            batteryKey: batteryKey\n        };\n        \n        // ç™¼é€æ§åˆ¶è¨Šæ¯\n        node.send([null, controlMsg, {\n            payload: `è‡ªå‹•é—œé–‰ ${battery.name}`,\n            topic: 'auto_stop'\n        }]);\n        \n        // æ¸…é™¤è¨ˆæ™‚å™¨\n        flow.set(`${batteryKey}_timer`, null);\n    }, chargingTimeMs);\n    \n    flow.set(`${batteryKey}_timer`, newTimerId);\n    \n    // æº–å‚™å……é›»é–‹å§‹é€šçŸ¥\n    const notifyMsg = {\n        payload: {\n            title: 'ğŸ”‹ å……é›»é–‹å§‹',\n            message: `ğŸ”‹ ${battery.name} é–‹å§‹å……é›»\\nâ±ï¸ é è¨ˆå……é›»æ™‚é–“ï¼š${battery.chargingTime}åˆ†é˜\\nğŸ• é–‹å§‹æ™‚é–“ï¼š${startTime.toLocaleString('zh-TW')}`\n        },\n        topic: 'charging_started',\n        batteryKey: batteryKey\n    };\n    \n    messages[0] = notifyMsg;\n    messages[2] = {\n        payload: `${battery.name} é–‹å§‹å……é›»ï¼Œè¨ˆæ™‚å™¨å·²è¨­å®š ${battery.chargingTime} åˆ†é˜`,\n        topic: 'charging_started',\n        batteryKey: batteryKey,\n        timerId: newTimerId\n    };\n}\n\n// æª¢æŸ¥æ˜¯å¦ç‚ºé—œé–‰ç‹€æ…‹\nelse if (newState === 'off' && oldState === 'on') {\n    // æ¸…é™¤è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${batteryKey}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n        flow.set(`${batteryKey}_timer`, null);\n    }\n    \n    // è¨ˆç®—å¯¦éš›å……é›»æ™‚é–“\n    const startTime = flow.get(`${batteryKey}_start`);\n    const actualTime = startTime ? Math.round((new Date().getTime() - startTime) / 60000) : 0;\n    \n    // æº–å‚™å……é›»å®Œæˆé€šçŸ¥\n    const notifyMsg = {\n        payload: {\n            title: 'âœ… å……é›»å®Œæˆ',\n            message: `âœ… ${battery.name} å……é›»å®Œæˆ\\nâ±ï¸ å……é›»æ™‚é•·ï¼š${actualTime}åˆ†é˜\\nğŸ• å®Œæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        topic: 'charging_completed',\n        batteryKey: batteryKey\n    };\n    \n    messages[0] = notifyMsg;\n    messages[2] = {\n        payload: `${battery.name} å……é›»å®Œæˆï¼Œå¯¦éš›æ™‚é–“ï¼š${actualTime}åˆ†é˜`,\n        topic: 'charging_completed',\n        batteryKey: batteryKey,\n        actualTime: actualTime\n    };\n}\n\n// éæ¿¾ç©ºè¨Šæ¯\nconst filteredMessages = messages.map(msg => msg || null);\n\nreturn filteredMessages;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 200,
        "wires": [["notification_handler"], ["device_controller"], ["debug_battery"]]
    },
    {
        "id": "notification_handler",
        "type": "function",
        "z": "battery_simple_tab",
        "name": "é€šçŸ¥è™•ç†å™¨",
        "func": "// ç²å–é€šçŸ¥é…ç½®\nconst notifyConfig = flow.get('notifyConfig');\n\nif (!notifyConfig || !notifyConfig.enabled) {\n    return null;\n}\n\n// æª¢æŸ¥æ˜¯å¦åœ¨éœéŸ³æ™‚é–“ (22:00-07:00)\nconst now = new Date();\nconst hour = now.getHours();\nconst isQuietTime = hour >= 22 || hour < 7;\n\nif (isQuietTime && msg.topic !== 'error') {\n    // éœéŸ³æ™‚é–“åªç™¼é€éŒ¯èª¤é€šçŸ¥\n    return null;\n}\n\nconst title = msg.payload.title || 'é›»æ± ç®¡ç†é€šçŸ¥';\nconst message = msg.payload.message || 'ç‹€æ…‹è®Šæ›´';\n\n// ç‚ºæ¯å€‹é€šçŸ¥æœå‹™å‰µå»ºè¨Šæ¯\nconst messages = [];\n\nnotifyConfig.services.forEach(service => {\n    messages.push({\n        payload: {\n            domain: 'notify',\n            service: service.replace('notify.', ''),\n            data: {\n                title: title,\n                message: message\n            }\n        },\n        topic: msg.topic,\n        service: service\n    });\n});\n\nreturn [messages];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 160,
        "wires": [["split_notifications"]]
    },
    {
        "id": "split_notifications",
        "type": "split",
        "z": "battery_simple_tab",
        "name": "åˆ†å‰²é€šçŸ¥",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 760,
        "y": 160,
        "wires": [["send_notification"]]
    },
    {
        "id": "send_notification",
        "type": "api-call-service",
        "z": "battery_simple_tab",
        "name": "ç™¼é€é€šçŸ¥",
        "server": "home_assistant_server",
        "version": 6,
        "debugenabled": false,
        "domain": "{{payload.domain}}",
        "service": "{{payload.service}}",
        "areaId": [],
        "deviceId": [],
        "entityId": "",
        "data": "{{payload.data}}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 920,
        "y": 160,
        "wires": [["debug_notification"]]
    },
    {
        "id": "device_controller",
        "type": "api-call-service",
        "z": "battery_simple_tab",
        "name": "è¨­å‚™æ§åˆ¶å™¨",
        "server": "home_assistant_server",
        "version": 6,
        "debugenabled": false,
        "domain": "{{payload.domain}}",
        "service": "{{payload.service}}",
        "areaId": [],
        "deviceId": [],
        "entityId": "{{payload.target.entity_id}}",
        "data": "{}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "x": 580,
        "y": 240,
        "wires": [["debug_control"]]
    },
    {
        "id": "debug_battery",
        "type": "debug",
        "z": "battery_simple_tab",
        "name": "é›»æ± Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 300,
        "wires": []
    },
    {
        "id": "debug_notification",
        "type": "debug",
        "z": "battery_simple_tab",
        "name": "é€šçŸ¥Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1100,
        "y": 160,
        "wires": []
    },
    {
        "id": "debug_control",
        "type": "debug",
        "z": "battery_simple_tab",
        "name": "æ§åˆ¶Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 760,
        "y": 240,
        "wires": []
    },
    {
        "id": "maintenance_check",
        "type": "inject",
        "z": "battery_simple_tab",
        "name": "ç¶­è­·æª¢æŸ¥",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "00 08 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "maintenance_check",
        "payloadType": "str",
        "x": 120,
        "y": 380,
        "wires": [["maintenance_logic"]]
    },
    {
        "id": "maintenance_logic",
        "type": "function",
        "z": "battery_simple_tab",
        "name": "ç¶­è­·å……é›»é‚è¼¯",
        "func": "// ç²å–é…ç½®\nconst batteryConfig = flow.get('batteryConfig');\nconst records = flow.get('chargingRecords') || {};\n\nif (!batteryConfig) {\n    node.error('é…ç½®æœªè¼‰å…¥');\n    return null;\n}\n\nconst now = new Date();\nconst messages = [];\n\n// æª¢æŸ¥æ¯å€‹é›»æ± çš„ç¶­è­·éœ€æ±‚\nObject.keys(batteryConfig).forEach(batteryKey => {\n    const battery = batteryConfig[batteryKey];\n    const record = records[batteryKey];\n    \n    if (!record || !record.lastCharge) {\n        // æ²’æœ‰å……é›»è¨˜éŒ„ï¼Œè·³é\n        return;\n    }\n    \n    const lastChargeDate = new Date(record.lastCharge);\n    const daysSinceCharge = Math.floor((now.getTime() - lastChargeDate.getTime()) / (1000 * 60 * 60 * 24));\n    \n    // æª¢æŸ¥æ˜¯å¦éœ€è¦ç¶­è­·å……é›»\n    if (daysSinceCharge >= battery.maintenanceDays) {\n        // éœ€è¦ç¶­è­·å……é›»\n        const domain = battery.entityId.includes('switch') ? 'switch' : 'media_player';\n        \n        const controlMsg = {\n            payload: {\n                domain: domain,\n                service: 'turn_on',\n                target: {\n                    entity_id: battery.entityId\n                }\n            },\n            topic: 'maintenance_charging',\n            batteryKey: batteryKey\n        };\n        \n        const notifyMsg = {\n            payload: {\n                title: 'ğŸ”„ ç¶­è­·å……é›»',\n                message: `ğŸ”„ ${battery.name} é–‹å§‹ç¶­è­·å……é›»\\nğŸ“… è·é›¢ä¸Šæ¬¡å……é›»ï¼š${daysSinceCharge}å¤©\\nâ±ï¸ é è¨ˆå……é›»æ™‚é–“ï¼š${battery.chargingTime}åˆ†é˜`\n            },\n            topic: 'maintenance_started',\n            batteryKey: batteryKey\n        };\n        \n        const debugMsg = {\n            payload: `ç¶­è­·å……é›»ï¼š${battery.name}ï¼Œè·é›¢ä¸Šæ¬¡å……é›» ${daysSinceCharge} å¤©`,\n            topic: 'maintenance_check',\n            batteryKey: batteryKey,\n            daysSinceCharge: daysSinceCharge\n        };\n        \n        messages.push([notifyMsg, controlMsg, debugMsg]);\n    }\n});\n\n// å¦‚æœæœ‰éœ€è¦ç¶­è­·çš„é›»æ± \nif (messages.length > 0) {\n    return messages;\n}\n\n// æ²’æœ‰éœ€è¦ç¶­è­·çš„é›»æ± \nreturn [null, null, {\n    payload: 'ç¶­è­·æª¢æŸ¥å®Œæˆï¼Œç„¡éœ€ç¶­è­·å……é›»',\n    topic: 'maintenance_check',\n    timestamp: now.toISOString()\n}];",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 380,
        "wires": [["notification_handler"], ["device_controller"], ["debug_maintenance"]]
    },
    {
        "id": "debug_maintenance",
        "type": "debug",
        "z": "battery_simple_tab",
        "name": "ç¶­è­·Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 380,
        "wires": []
    },
    {
        "id": "manual_maintenance",
        "type": "inject",
        "z": "battery_simple_tab",
        "name": "æ‰‹å‹•ç¶­è­·æª¢æŸ¥",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "manual_maintenance_check",
        "payloadType": "str",
        "x": 120,
        "y": 440,
        "wires": [["maintenance_logic"]]
    },
    {
        "id": "view_records",
        "type": "inject",
        "z": "battery_simple_tab",
        "name": "æŸ¥çœ‹å……é›»è¨˜éŒ„",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "view_records",
        "payloadType": "str",
        "x": 120,
        "y": 500,
        "wires": [["show_records"]]
    },
    {
        "id": "show_records",
        "type": "function",
        "z": "battery_simple_tab",
        "name": "é¡¯ç¤ºè¨˜éŒ„",
        "func": "const batteryConfig = flow.get('batteryConfig');\nconst records = flow.get('chargingRecords') || {};\n\nif (!batteryConfig) {\n    msg.payload = 'é…ç½®æœªè¼‰å…¥';\n    return msg;\n}\n\nconst now = new Date();\nlet report = 'ğŸ“Š å……é›»è¨˜éŒ„å ±å‘Š\\n\\n';\n\nObject.keys(batteryConfig).forEach(batteryKey => {\n    const battery = batteryConfig[batteryKey];\n    const record = records[batteryKey] || {};\n    \n    report += `ğŸ”‹ ${battery.name}\\n`;\n    \n    if (record.lastCharge) {\n        const lastChargeDate = new Date(record.lastCharge);\n        const daysSinceCharge = Math.floor((now.getTime() - lastChargeDate.getTime()) / (1000 * 60 * 60 * 24));\n        \n        report += `   ğŸ“… ä¸Šæ¬¡å……é›»ï¼š${lastChargeDate.toLocaleString('zh-TW')}\\n`;\n        report += `   â° è·ä»Šå¤©æ•¸ï¼š${daysSinceCharge}å¤©\\n`;\n        report += `   ğŸ”„ ç¶­è­·é€±æœŸï¼š${battery.maintenanceDays}å¤©\\n`;\n        report += `   ğŸ“ˆ å……é›»æ¬¡æ•¸ï¼š${record.chargingCount || 0}æ¬¡\\n`;\n        \n        if (daysSinceCharge >= battery.maintenanceDays) {\n            report += `   âš ï¸ éœ€è¦ç¶­è­·å……é›»\\n`;\n        } else {\n            const daysLeft = battery.maintenanceDays - daysSinceCharge;\n            report += `   âœ… é‚„æœ‰${daysLeft}å¤©éœ€è¦ç¶­è­·\\n`;\n        }\n    } else {\n        report += `   âŒ ç„¡å……é›»è¨˜éŒ„\\n`;\n    }\n    \n    report += '\\n';\n});\n\nmsg.payload = report;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 500,
        "wires": [["debug_records"]]
    },
    {
        "id": "debug_records",
        "type": "debug",
        "z": "battery_simple_tab",
        "name": "è¨˜éŒ„Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 500,
        "y": 500,
        "wires": []
    },
    {
        "id": "home_assistant_server",
        "type": "server",
        "name": "Home Assistant",
        "version": 4,
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "y|yes|true|on|home|open",
        "connectionDelay": true,
        "cacheJson": true,
        "heartbeat": false,
        "heartbeatInterval": 30
    }
]
