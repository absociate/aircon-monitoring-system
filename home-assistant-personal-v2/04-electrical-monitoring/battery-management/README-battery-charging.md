# ğŸ”‹ æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ±

## ğŸ“‹ ç³»çµ±æ¦‚è¿°

é€™æ˜¯ä¸€å€‹å°ˆç‚ºæ‚¨çš„HS300æ™ºèƒ½æ’åº§è¨­è¨ˆçš„å……é›»é›»æ± ç®¡ç†ç³»çµ±ï¼Œæ”¯æ´ç‰§ç”°BL1041Bå’ŒENELOOPå……é›»é›»æ± çš„æ™ºèƒ½å……é›»ç®¡ç†ã€‚

### ğŸ¯ ä¸»è¦åŠŸèƒ½

- âœ… **æ‰‹å‹•å……é›»è‡ªå‹•ç®¡ç†**ï¼šæª¢æ¸¬æ‰‹å‹•é–‹å•Ÿï¼Œè‡ªå‹•è¨ˆæ™‚é—œé–‰
- âœ… **å®šæœŸç¶­è­·å……é›»**ï¼šæ ¹æ“šé›»æ± ç‰¹æ€§è‡ªå‹•ç¶­è­·
- âœ… **å¤šé‡é€šçŸ¥ç³»çµ±**ï¼šNotifyHelperã€Synology Chatã€Telegram
- âœ… **å®‰å…¨ä¿è­·æ©Ÿåˆ¶**ï¼šé˜²æ­¢éåº¦å……é›»å’Œé‡è¤‡å•Ÿå‹•
- âœ… **å¯é…ç½®åƒæ•¸**ï¼šå……é›»æ™‚é–“å’Œç¶­è­·é€±æœŸå¯èª¿æ•´

### ğŸ”Œ æ”¯æ´è¨­å‚™

| é›»æ± é¡å‹ | æ’åº§ä½ç½® | å¯¦é«”ID | å……é›»æ™‚é–“ | ç¶­è­·é€±æœŸ |
|---------|---------|--------|---------|---------|
| ç‰§ç”°BL1041B | HS300 2-4æ’åº§ | `media_player.volume_set` | 90åˆ†é˜ | 30å¤© |
| ENELOOP 3è™Ÿ | HS300 2-5æ’åº§ | `switch.tp_link_power_strip_eb2f_cha_shang_5` | 240åˆ†é˜ | 60å¤© |
| ENELOOP 4è™Ÿ | HS300 2-6æ’åº§ | `switch.tp_link_power_strip_eb2f_cha_shang_6` | 210åˆ†é˜ | 60å¤© |

---

## ğŸš€ å®‰è£æ­¥é©Ÿ

### 1ï¸âƒ£ å®‰è£Home Assistantè¼”åŠ©å¯¦é«”

å°‡ `battery-helpers.yaml` çš„å…§å®¹æ·»åŠ åˆ°æ‚¨çš„ Home Assistant é…ç½®ä¸­ï¼š

```bash
# æ–¹æ³•ä¸€ï¼šæ·»åŠ åˆ° configuration.yaml
cat battery-helpers.yaml >> configuration.yaml

# æ–¹æ³•äºŒï¼šå‰µå»ºå–®ç¨çš„ helpers.yaml æ–‡ä»¶
cp battery-helpers.yaml config/helpers.yaml
```

ç„¶å¾Œåœ¨ `configuration.yaml` ä¸­æ·»åŠ ï¼š
```yaml
# å¦‚æœä½¿ç”¨å–®ç¨çš„ helpers.yaml æ–‡ä»¶
homeassistant:
  packages: !include_dir_named packages/
```

### 2ï¸âƒ£ é‡å•ŸHome Assistant

```bash
# é‡å•ŸHome Assistantä»¥è¼‰å…¥æ–°çš„è¼”åŠ©å¯¦é«”
sudo systemctl restart home-assistant@homeassistant
```

### 3ï¸âƒ£ å°å…¥Node-REDæµç¨‹

1. **æ‰“é–‹Node-REDç·¨è¼¯å™¨**
   ```
   http://æ¨¹è“æ´¾IP:1880
   ```

2. **å°å…¥æµç¨‹æ–‡ä»¶**
   - é»æ“Šå³ä¸Šè§’é¸å–® â†’ å°å…¥
   - é¸æ“‡ `battery-charging-flow.json` æ–‡ä»¶
   - é»æ“Šã€Œå°å…¥ã€

3. **é…ç½®Home Assistanté€£æ¥**
   - é›™æ“Šä»»ä¸€å€‹ç¯€é»
   - é»æ“Šã€ŒServerã€æ—çš„ç·¨è¼¯æŒ‰éˆ•
   - é…ç½®é€£æ¥è³‡è¨Šï¼š
     - **Base URL**: `http://localhost:8123`ï¼ˆåŒå°æ¨¹è“æ´¾ï¼‰
     - **Access Token**: å¾HAç”¨æˆ¶è¨­å®šä¸­ç”Ÿæˆ

### 4ï¸âƒ£ è¼‰å…¥é…ç½®æ–‡ä»¶

åœ¨Node-REDä¸­æ·»åŠ ä¸€å€‹åˆå§‹åŒ–ç¯€é»ä¾†è¼‰å…¥é…ç½®ï¼š

1. æ‹–æ‹½ä¸€å€‹ã€Œinjectã€ç¯€é»åˆ°å·¥ä½œå€
2. è¨­å®šç‚ºã€Œinject once after 0.1 secondsã€
3. é€£æ¥åˆ°ä¸€å€‹ã€Œfunctionã€ç¯€é»
4. åœ¨functionç¯€é»ä¸­è²¼å…¥ä»¥ä¸‹ä»£ç¢¼ï¼š

```javascript
// è¼‰å…¥é›»æ± å……é›»é…ç½®
const fs = require('fs');
const path = require('path');

try {
    // è®€å–é…ç½®æ–‡ä»¶
    const configPath = path.join(__dirname, 'battery-config.js');
    delete require.cache[require.resolve(configPath)];
    const config = require(configPath);
    
    // è¨­å®šå…¨åŸŸè®Šæ•¸
    global.set('batteryChargingConfig', config);
    
    node.status({fill:"green", shape:"dot", text:"é…ç½®å·²è¼‰å…¥"});
    msg.payload = "é›»æ± å……é›»é…ç½®å·²æˆåŠŸè¼‰å…¥";
} catch (error) {
    node.status({fill:"red", shape:"ring", text:"é…ç½®è¼‰å…¥å¤±æ•—"});
    msg.payload = "é…ç½®è¼‰å…¥å¤±æ•—: " + error.message;
}

return msg;
```

---

## âš™ï¸ é…ç½®èªªæ˜

### ğŸ”§ åŸºæœ¬è¨­å®š

åœ¨Home Assistantä¸­ï¼Œæ‚¨å¯ä»¥é€éä»¥ä¸‹å¯¦é«”æ§åˆ¶ç³»çµ±ï¼š

#### ç³»çµ±é–‹é—œ
- `input_boolean.battery_management_enabled` - é›»æ± ç®¡ç†ç³»çµ±ç¸½é–‹é—œ
- `input_boolean.battery_auto_maintenance` - è‡ªå‹•ç¶­è­·å……é›»é–‹é—œ
- `input_boolean.battery_charging_notifications` - å……é›»é€šçŸ¥é–‹é—œ

#### å€‹åˆ¥é›»æ± æ§åˆ¶
- `input_boolean.makita_charging_enabled` - ç‰§ç”°é›»æ± å……é›»ç®¡ç†
- `input_boolean.eneloop_aa_charging_enabled` - ENELOOP 3è™Ÿé›»æ± å……é›»ç®¡ç†
- `input_boolean.eneloop_aaa_charging_enabled` - ENELOOP 4è™Ÿé›»æ± å……é›»ç®¡ç†

#### å……é›»æ™‚é–“è¨­å®š
- `input_number.makita_charging_time` - ç‰§ç”°é›»æ± å……é›»æ™‚é–“ï¼ˆ30-180åˆ†é˜ï¼‰
- `input_number.eneloop_aa_charging_time` - ENELOOP 3è™Ÿå……é›»æ™‚é–“ï¼ˆ60-360åˆ†é˜ï¼‰
- `input_number.eneloop_aaa_charging_time` - ENELOOP 4è™Ÿå……é›»æ™‚é–“ï¼ˆ60-300åˆ†é˜ï¼‰

#### ç¶­è­·é€±æœŸè¨­å®š
- `input_number.makita_maintenance_cycle` - ç‰§ç”°é›»æ± ç¶­è­·é€±æœŸï¼ˆ7-90å¤©ï¼‰
- `input_number.eneloop_maintenance_cycle` - ENELOOPé›»æ± ç¶­è­·é€±æœŸï¼ˆ14-120å¤©ï¼‰

### ğŸ“± é€šçŸ¥è¨­å®š

ç·¨è¼¯ `battery-config.js` ä¸­çš„é€šçŸ¥é…ç½®ï¼š

```javascript
const notificationConfig = {
    notifyHelper: {
        enabled: true,
        service: 'notify.notify',
        targets: ['person.your_name'], // ä¿®æ”¹ç‚ºæ‚¨çš„personå¯¦é«”
        priority: 'normal'
    },
    synologyChat: {
        enabled: true,
        service: 'notify.synology_chat_bot_3', // ä¿®æ”¹ç‚ºæ‚¨çš„æœå‹™åç¨±
        username: 'Battery Manager',
        channel: '#smart-home'
    },
    telegram: {
        enabled: true,
        service: 'notify.telegram', // ä¿®æ”¹ç‚ºæ‚¨çš„æœå‹™åç¨±
        parseMode: 'HTML'
    }
};
```

---

## ğŸ® ä½¿ç”¨æ–¹æ³•

### ğŸ“± æ‰‹å‹•å……é›»

1. **é–‹å§‹å……é›»**ï¼šæ‰‹å‹•é–‹å•Ÿå°æ‡‰çš„æ™ºèƒ½æ’åº§
2. **è‡ªå‹•ç®¡ç†**ï¼šç³»çµ±è‡ªå‹•æª¢æ¸¬ä¸¦å•Ÿå‹•è¨ˆæ™‚å™¨
3. **é€šçŸ¥æé†’**ï¼šæ”¶åˆ°å……é›»é–‹å§‹é€šçŸ¥
4. **è‡ªå‹•é—œé–‰**ï¼šé”åˆ°è¨­å®šæ™‚é–“å¾Œè‡ªå‹•é—œé–‰æ’åº§
5. **å®Œæˆé€šçŸ¥**ï¼šæ”¶åˆ°å……é›»å®Œæˆé€šçŸ¥

### ğŸ”„ ç¶­è­·å……é›»

ç³»çµ±æ¯æ—¥æ—©ä¸Š8é»è‡ªå‹•æª¢æŸ¥ï¼š
- è¨ˆç®—è·é›¢ä¸Šæ¬¡å……é›»çš„å¤©æ•¸
- å¦‚æœè¶…éç¶­è­·é€±æœŸï¼Œè‡ªå‹•é–‹å•Ÿå……é›»
- ç™¼é€ç¶­è­·å……é›»é€šçŸ¥
- åŸ·è¡Œå®Œæ•´å……é›»æµç¨‹

### ğŸ“Š ç‹€æ…‹ç›£æ§

åœ¨Home Assistantä¸­æŸ¥çœ‹ï¼š
- `sensor.makita_days_since_charge` - ç‰§ç”°é›»æ± è·é›¢ä¸Šæ¬¡å……é›»å¤©æ•¸
- `sensor.eneloop_aa_days_since_charge` - ENELOOP 3è™Ÿè·é›¢ä¸Šæ¬¡å……é›»å¤©æ•¸
- `sensor.eneloop_aaa_days_since_charge` - ENELOOP 4è™Ÿè·é›¢ä¸Šæ¬¡å……é›»å¤©æ•¸

---

## ğŸ›¡ï¸ å®‰å…¨æ©Ÿåˆ¶

### â° å……é›»æ™‚é–“ä¿è­·
- æ¯ç¨®é›»æ± éƒ½æœ‰æœ€å¤§å……é›»æ™‚é–“é™åˆ¶
- é”åˆ°ä¸Šé™è‡ªå‹•åœæ­¢ä¸¦ç™¼é€å®‰å…¨é€šçŸ¥

### ğŸ”„ é‡è¤‡å•Ÿå‹•é˜²è­·
- æª¢æ¸¬æ˜¯å¦å·²æœ‰è¨ˆæ™‚å™¨é‹è¡Œ
- é¿å…é‡è¤‡å•Ÿå‹•é€ æˆçš„å•é¡Œ

### ğŸŒ™ éœéŸ³æ™‚é–“
- æ™šä¸Š22:00åˆ°æ—©ä¸Š07:00ç‚ºéœéŸ³æ™‚é–“
- åƒ…ç·Šæ€¥é€šçŸ¥ï¼ˆéŒ¯èª¤ã€å®‰å…¨åœæ­¢ï¼‰æœƒç™¼é€

### ğŸ“± å¤šé‡é€šçŸ¥
- åŒæ™‚ç™¼é€åˆ°å¤šå€‹é€šçŸ¥å¹³å°
- ç¢ºä¿é‡è¦è¨Šæ¯ä¸æœƒéºæ¼

---

## ğŸ”§ æ•…éšœæ’é™¤

### âŒ é…ç½®æœªè¼‰å…¥
**ç—‡ç‹€**ï¼šç³»çµ±ç„¡åæ‡‰ï¼Œç„¡é€šçŸ¥
**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥ `battery-config.js` æ–‡ä»¶è·¯å¾‘
2. ç¢ºèªNode-REDæœ‰è®€å–æ¬Šé™
3. é‡æ–°éƒ¨ç½²æµç¨‹

### âŒ é€šçŸ¥æœªç™¼é€
**ç—‡ç‹€**ï¼šå……é›»æ­£å¸¸ä½†ç„¡é€šçŸ¥
**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥é€šçŸ¥æœå‹™é…ç½®
2. ç¢ºèªHome Assistanté€šçŸ¥æœå‹™æ­£å¸¸
3. æª¢æŸ¥éœéŸ³æ™‚é–“è¨­å®š

### âŒ æ’åº§ç„¡æ³•æ§åˆ¶
**ç—‡ç‹€**ï¼šè¨ˆæ™‚å™¨æ­£å¸¸ä½†æ’åº§æœªé—œé–‰
**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªå¯¦é«”IDæ­£ç¢º
2. æª¢æŸ¥Home Assistanté€£æ¥
3. æ¸¬è©¦æ‰‹å‹•æ§åˆ¶æ’åº§

### âŒ ç¶­è­·å……é›»æœªè§¸ç™¼
**ç—‡ç‹€**ï¼šè¶…éç¶­è­·é€±æœŸä½†æœªè‡ªå‹•å……é›»
**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥ç³»çµ±é–‹é—œç‹€æ…‹
2. ç¢ºèªç¶­è­·å……é›»é–‹é—œå·²å•Ÿç”¨
3. æª¢æŸ¥å®šæ™‚è§¸ç™¼å™¨è¨­å®š

---

## ğŸ“ˆ é€²éšåŠŸèƒ½

### ğŸ›ï¸ è‡ªè¨‚å……é›»æ¨¡å¼

æ‚¨å¯ä»¥åœ¨ `battery-config.js` ä¸­æ·»åŠ è‡ªè¨‚æ¨¡å¼ï¼š

```javascript
// å¿«é€Ÿå……é›»æ¨¡å¼
const quickChargeMode = {
    makita: { chargingTime: 60 },      // 1å°æ™‚å¿«å……
    eneloop_aa: { chargingTime: 180 }, // 3å°æ™‚å¿«å……
    eneloop_aaa: { chargingTime: 150 } // 2.5å°æ™‚å¿«å……
};
```

### ğŸ“Š å……é›»çµ±è¨ˆ

ç³»çµ±è‡ªå‹•è¨˜éŒ„ï¼š
- ä¸Šæ¬¡å……é›»æ™‚é–“
- å……é›»æ¬¡æ•¸çµ±è¨ˆ
- ç¶­è­·å……é›»è¨˜éŒ„

### ğŸŒ¡ï¸ æº«åº¦ç›£æ§ï¼ˆå¯é¸ï¼‰

å¦‚æœæ‚¨æœ‰æº«åº¦æ„Ÿæ¸¬å™¨ï¼Œå¯ä»¥å•Ÿç”¨æº«åº¦ç›£æ§ï¼š

```javascript
const systemConfig = {
    safety: {
        temperatureMonitoring: true,
        maxTemperature: 45 // æ”æ°åº¦
    }
};
```

---

## ğŸ“ æŠ€è¡“æ”¯æ´

å¦‚æœæ‚¨é‡åˆ°å•é¡Œï¼š

1. **æª¢æŸ¥æ—¥èªŒ**ï¼šæŸ¥çœ‹Node-REDå’ŒHome Assistantæ—¥èªŒ
2. **æ¸¬è©¦é€£æ¥**ï¼šç¢ºèªæ‰€æœ‰æœå‹™æ­£å¸¸é‹è¡Œ
3. **é‡æ–°éƒ¨ç½²**ï¼šå˜—è©¦é‡æ–°å°å…¥æµç¨‹
4. **é‡å•Ÿæœå‹™**ï¼šé‡å•ŸNode-REDå’ŒHome Assistant

---

## ğŸ”„ æ›´æ–°èªªæ˜

### v1.0.0 (åˆå§‹ç‰ˆæœ¬)
- åŸºæœ¬å……é›»ç®¡ç†åŠŸèƒ½
- å¤šé‡é€šçŸ¥ç³»çµ±
- å®‰å…¨ä¿è­·æ©Ÿåˆ¶
- ç¶­è­·å……é›»åŠŸèƒ½
