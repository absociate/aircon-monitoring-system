[
    {
        "id": "7aa6bd9d6c51a86b",
        "type": "tab",
        "label": "æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - å®‰å…¨åŠ å¼·ç‰ˆ",
        "disabled": false,
        "info": "æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - å®‰å…¨åŠ å¼·ç‰ˆ\n\nðŸ›¡ï¸ æ–°å¢žå®‰å…¨åŠŸèƒ½ï¼š\n1. é›™é‡è¨ˆæ™‚å™¨ä¿è­·ï¼ˆä¸»è¨ˆæ™‚å™¨ + å®‰å…¨è¨ˆæ™‚å™¨ï¼‰\n2. å®šæœŸå®‰å…¨æª¢æŸ¥ï¼ˆæ¯10åˆ†é˜ï¼‰\n3. æŒä¹…åŒ–å……é›»è¨˜éŒ„ï¼ˆé‡å•Ÿå¾Œä»æœ‰æ•ˆï¼‰\n4. ç·Šæ€¥é—œé–‰åŠŸèƒ½\n5. åˆ†ç´šè­¦å ±ç³»çµ±\n6. æœ€å¤§å……é›»æ™‚é–“ç¡¬é™åˆ¶\n\nâš ï¸ é˜²æ­¢éŽåº¦å……é›»ï¼š\n- ä¸»è¨ˆæ™‚å™¨ï¼šæ­£å¸¸å……é›»æ™‚é–“\n- å®‰å…¨è¨ˆæ™‚å™¨ï¼š150%æ™‚é–“å¼·åˆ¶é—œé–‰\n- å®šæœŸæª¢æŸ¥ï¼šæ¯10åˆ†é˜æª¢æŸ¥å……é›»ç‹€æ…‹\n- ç·Šæ€¥é—œé–‰ï¼šä¸€éµé—œé–‰æ‰€æœ‰å……é›»\n\næ”¯æ´è¨­å‚™ï¼š\n- ç‰§ç”°BL1041B (90åˆ†é˜ï¼Œå®‰å…¨é™åˆ¶135åˆ†é˜)\n- ENELOOP 3è™Ÿ (240åˆ†é˜ï¼Œå®‰å…¨é™åˆ¶360åˆ†é˜)\n- ENELOOP 4è™Ÿ (210åˆ†é˜ï¼Œå®‰å…¨é™åˆ¶315åˆ†é˜)\n\né€šçŸ¥æœå‹™ï¼š\n- NotifyHelper (notify.notify_person â†’ person.ming)\n- Synology Chat (notify.synology_chat_bot_3)\n- Telegram (notify.telegram)",
        "env": []
    },
    {
        "id": "emergency_stop_all",
        "type": "inject",
        "z": "7aa6bd9d6c51a86b",
        "name": "ðŸš¨ ç·Šæ€¥é—œé–‰æ‰€æœ‰å……é›»",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "emergency_stop",
        "payloadType": "str",
        "x": 130,
        "y": 20,
        "wires": [["emergency_handler"]]
    },
    {
        "id": "emergency_handler",
        "type": "function",
        "z": "7aa6bd9d6c51a86b",
        "name": "ç·Šæ€¥è™•ç†å™¨",
        "func": "// é›»æ± é…ç½®\nconst batteries = {\n    makita: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_4',\n        name: 'ç‰§ç”°BL1041Bå……é›»é›»æ± ',\n        domain: 'switch'\n    },\n    eneloop_aa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_5',\n        name: 'ENELOOP 3è™Ÿå……é›»é›»æ± ',\n        domain: 'switch'\n    },\n    eneloop_aaa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_6',\n        name: 'ENELOOP 4è™Ÿå……é›»é›»æ± ',\n        domain: 'switch'\n    }\n};\n\n// æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨å’Œè¨˜éŒ„\nfor (const key of Object.keys(batteries)) {\n    // æ¸…é™¤ä¸»è¨ˆæ™‚å™¨\n    const timerId = flow.get(`${key}_timer`);\n    if (timerId) {\n        clearTimeout(timerId);\n        flow.set(`${key}_timer`, null);\n    }\n    \n    // æ¸…é™¤å®‰å…¨è¨ˆæ™‚å™¨\n    const safetyTimerId = flow.get(`${key}_safety_timer`);\n    if (safetyTimerId) {\n        clearTimeout(safetyTimerId);\n        flow.set(`${key}_safety_timer`, null);\n    }\n    \n    // æ¸…é™¤å……é›»è¨˜éŒ„\n    context.set(`${key}_charging`, null);\n}\n\n// æº–å‚™ç·Šæ€¥é€šçŸ¥\nconst notifyMsg = {\n    payload: {\n        title: 'ðŸš¨ ç·Šæ€¥é—œé–‰å……é›»',\n        message: `ðŸš¨ å·²åŸ·è¡Œç·Šæ€¥é—œé–‰æ‰€æœ‰å……é›»è¨­å‚™\\n\\né—œé–‰è¨­å‚™ï¼š\\nâ€¢ ç‰§ç”°BL1041Bå……é›»é›»æ± \\nâ€¢ ENELOOP 3è™Ÿå……é›»é›»æ± \\nâ€¢ ENELOOP 4è™Ÿå……é›»é›»æ± \\n\\nâ° åŸ·è¡Œæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\\n\\nè«‹æª¢æŸ¥è¨­å‚™ç‹€æ…‹å’Œé›»æ± æº«åº¦ã€‚`\n    },\n    action: 'emergency_stop'\n};\n\n// æº–å‚™é—œé–‰å‘½ä»¤\nconst outputs = [notifyMsg];\n\nfor (const [key, battery] of Object.entries(batteries)) {\n    outputs.push({\n        payload: {\n            domain: battery.domain,\n            service: 'turn_off',\n            target: {\n                entity_id: battery.entityId\n            }\n        },\n        batteryKey: key,\n        action: 'emergency_stop'\n    });\n}\n\nnode.status({fill:\"red\", shape:\"dot\", text:\"ç·Šæ€¥é—œé–‰åŸ·è¡Œ\"});\n\nreturn outputs;",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 20,
        "wires": [["d320c63adb96c9b2"], ["57a17fab27364441"], ["57a17fab27364441"], ["57a17fab27364441"]]
    },
    {
        "id": "safety_check_timer",
        "type": "inject",
        "z": "7aa6bd9d6c51a86b",
        "name": "ðŸ” å®‰å…¨æª¢æŸ¥ï¼ˆæ¯10åˆ†é˜ï¼‰",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "600",
        "crontab": "",
        "once": true,
        "onceDelay": 60,
        "topic": "",
        "payload": "safety_check",
        "payloadType": "str",
        "x": 140,
        "y": 80,
        "wires": [["safety_checker"]]
    },
    {
        "id": "safety_checker",
        "type": "function",
        "z": "7aa6bd9d6c51a86b",
        "name": "å®‰å…¨æª¢æŸ¥å™¨",
        "func": "// é›»æ± é…ç½®\nconst batteries = {\n    makita: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_4',\n        name: 'ç‰§ç”°BL1041Bå……é›»é›»æ± ',\n        chargingTime: 90,\n        domain: 'switch'\n    },\n    eneloop_aa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_5',\n        name: 'ENELOOP 3è™Ÿå……é›»é›»æ± ',\n        chargingTime: 240,\n        domain: 'switch'\n    },\n    eneloop_aaa: {\n        entityId: 'switch.tp_link_power_strip_eb2f_cha_shang_6',\n        name: 'ENELOOP 4è™Ÿå……é›»é›»æ± ',\n        chargingTime: 210,\n        domain: 'switch'\n    }\n};\n\nconst now = Date.now();\nconst outputs = [null, null, null]; // [é€šçŸ¥, æŽ§åˆ¶, debug]\nlet warnings = [];\nlet emergencyStops = [];\n\n// æª¢æŸ¥æ¯å€‹é›»æ± çš„å……é›»ç‹€æ…‹\nfor (const [key, battery] of Object.entries(batteries)) {\n    const chargingInfo = context.get(`${key}_charging`);\n    \n    if (chargingInfo && chargingInfo.startTime) {\n        const chargingMinutes = Math.round((now - chargingInfo.startTime) / 60000);\n        const maxTime = battery.chargingTime;\n        const warningTime = Math.round(maxTime * 1.5); // 150%è­¦å‘Š\n        const emergencyTime = Math.round(maxTime * 2.0); // 200%ç·Šæ€¥é—œé–‰\n        \n        if (chargingMinutes >= emergencyTime) {\n            // ç·Šæ€¥é—œé–‰\n            emergencyStops.push({\n                battery: battery,\n                key: key,\n                chargingMinutes: chargingMinutes,\n                maxTime: maxTime\n            });\n        } else if (chargingMinutes >= warningTime) {\n            // è­¦å‘Š\n            warnings.push({\n                battery: battery,\n                key: key,\n                chargingMinutes: chargingMinutes,\n                maxTime: maxTime\n            });\n        }\n    }\n}\n\n// è™•ç†ç·Šæ€¥é—œé–‰\nif (emergencyStops.length > 0) {\n    const stopList = emergencyStops.map(item => \n        `â€¢ ${item.battery.name}: ${item.chargingMinutes}åˆ†é˜ (è¶…éŽ${item.maxTime}åˆ†é˜${Math.round((item.chargingMinutes/item.maxTime-1)*100)}%)`\n    ).join('\\n');\n    \n    outputs[0] = {\n        payload: {\n            title: 'ðŸš¨ ç·Šæ€¥é—œé–‰éŽåº¦å……é›»',\n            message: `ðŸš¨ æª¢æ¸¬åˆ°åš´é‡éŽåº¦å……é›»ï¼Œç«‹å³é—œé–‰ï¼š\\n${stopList}\\n\\nâš ï¸ è«‹æª¢æŸ¥é›»æ± å’Œå……é›»å™¨ç‹€æ…‹\\nðŸ• æª¢æŸ¥æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        action: 'emergency_safety_stop'\n    };\n    \n    // é—œé–‰ç¬¬ä¸€å€‹éŽåº¦å……é›»çš„è¨­å‚™\n    const firstStop = emergencyStops[0];\n    outputs[1] = {\n        payload: {\n            domain: firstStop.battery.domain,\n            service: 'turn_off',\n            target: {\n                entity_id: firstStop.battery.entityId\n            }\n        },\n        batteryKey: firstStop.key,\n        action: 'emergency_safety_stop'\n    };\n    \n    // æ¸…é™¤å……é›»è¨˜éŒ„\n    emergencyStops.forEach(item => {\n        context.set(`${item.key}_charging`, null);\n        const timerId = flow.get(`${item.key}_timer`);\n        const safetyTimerId = flow.get(`${item.key}_safety_timer`);\n        if (timerId) {\n            clearTimeout(timerId);\n            flow.set(`${item.key}_timer`, null);\n        }\n        if (safetyTimerId) {\n            clearTimeout(safetyTimerId);\n            flow.set(`${item.key}_safety_timer`, null);\n        }\n    });\n}\n\n// è™•ç†è­¦å‘Š\nelse if (warnings.length > 0) {\n    const warnList = warnings.map(item => \n        `â€¢ ${item.battery.name}: ${item.chargingMinutes}åˆ†é˜ (è¨­å®š${item.maxTime}åˆ†é˜)`\n    ).join('\\n');\n    \n    outputs[0] = {\n        payload: {\n            title: 'âš ï¸ å……é›»æ™‚é–“è­¦å‘Š',\n            message: `âš ï¸ ä»¥ä¸‹é›»æ± å……é›»æ™‚é–“è¶…éŽè¨­å®šå€¼50%ï¼š\\n${warnList}\\n\\nå»ºè­°æª¢æŸ¥å……é›»ç‹€æ…‹\\nðŸ• æª¢æŸ¥æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`\n        },\n        action: 'charging_warning'\n    };\n}\n\n// Debugè¼¸å‡º\noutputs[2] = {\n    payload: 'å®‰å…¨æª¢æŸ¥å®Œæˆ',\n    warnings: warnings.length,\n    emergencyStops: emergencyStops.length,\n    checkTime: new Date().toISOString()\n};\n\nnode.status({\n    fill: emergencyStops.length > 0 ? \"red\" : warnings.length > 0 ? \"yellow\" : \"green\",\n    shape: \"dot\",\n    text: `æª¢æŸ¥: ${warnings.length}è­¦å‘Š, ${emergencyStops.length}ç·Šæ€¥`\n});\n\nreturn outputs;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 80,
        "wires": [["d320c63adb96c9b2"], ["57a17fab27364441"], ["debug_safety"]]
    }
]
