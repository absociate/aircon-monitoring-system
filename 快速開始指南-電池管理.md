# ğŸš€ æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ± - å¿«é€Ÿé–‹å§‹æŒ‡å—

## ğŸ“‹ ç³»çµ±æ¦‚è¿°

é€™å€‹ç³»çµ±å°ˆç‚ºæ‚¨çš„HS300æ™ºèƒ½æ’åº§è¨­è¨ˆï¼Œå¯ä»¥æ™ºèƒ½ç®¡ç†ç‰§ç”°BL1041Bå’ŒENELOOPå……é›»é›»æ± çš„å……é›»éç¨‹ã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
- ğŸ”‹ **æ‰‹å‹•å……é›»è‡ªå‹•ç®¡ç†**ï¼šæ‰‹å‹•é–‹å•Ÿå¾Œè‡ªå‹•è¨ˆæ™‚é—œé–‰
- ğŸ”„ **å®šæœŸç¶­è­·å……é›»**ï¼šæ ¹æ“šé›»æ± ç‰¹æ€§è‡ªå‹•ç¶­è­·
- ğŸ“± **å¤šé‡é€šçŸ¥ç³»çµ±**ï¼šNotifyHelperã€Synology Chatã€Telegram
- ğŸ›¡ï¸ **å®‰å…¨ä¿è­·æ©Ÿåˆ¶**ï¼šé˜²æ­¢éåº¦å……é›»

### ğŸ”Œ æ‚¨çš„è¨­å‚™é…ç½®

| é›»æ± é¡å‹ | æ’åº§ä½ç½® | å¯¦é«”ID | å……é›»æ™‚é–“ | ç¶­è­·é€±æœŸ |
|---------|---------|--------|---------|---------|
| ç‰§ç”°BL1041B | HS300 2-4æ’åº§ | `media_player.volume_set` | 90åˆ†é˜ | 30å¤© |
| ENELOOP 3è™Ÿ | HS300 2-5æ’åº§ | `switch.tp_link_power_strip_eb2f_cha_shang_5` | 240åˆ†é˜ | 60å¤© |
| ENELOOP 4è™Ÿ | HS300 2-6æ’åº§ | `switch.tp_link_power_strip_eb2f_cha_shang_6` | 210åˆ†é˜ | 60å¤© |

---

## âš¡ 5åˆ†é˜å¿«é€Ÿå®‰è£

### ğŸ”§ é‡è¦ï¼šå…ˆä¿®æ­£Node-REDç›¸å®¹æ€§å•é¡Œ

**å¦‚æœæ‚¨é‡åˆ° `unknown:call-service` éŒ¯èª¤ï¼Œè«‹å…ˆåŸ·è¡Œï¼š**

```bash
# åŸ·è¡Œç›¸å®¹æ€§ä¿®æ­£è…³æœ¬
chmod +x fix-node-red-compatibility.sh
./fix-node-red-compatibility.sh
```

**æˆ–æ‰‹å‹•ä¿®æ­£ï¼š**

```bash
# æ›´æ–°Home Assistantç¯€é»
cd ~/.node-red
npm update node-red-contrib-home-assistant-websocket
sudo systemctl restart nodered
```

### æ­¥é©Ÿ1ï¼šå®‰è£Home Assistantè¼”åŠ©å¯¦é«”

1. **è¤‡è£½é…ç½®æ–‡ä»¶**
   ```bash
   # åœ¨æ‚¨çš„æ¨¹è“æ´¾ä¸ŠåŸ·è¡Œ
   cd /config
   mkdir -p packages
   # å°‡ battery-helpers.yaml è¤‡è£½åˆ° packages ç›®éŒ„
   ```

2. **ä¿®æ”¹configuration.yaml**
   åœ¨ `/config/configuration.yaml` æœ«å°¾æ·»åŠ ï¼š
   ```yaml
   # æ™ºèƒ½å……é›»é›»æ± ç®¡ç†ç³»çµ±
   homeassistant:
     packages: !include_dir_named packages/
   ```

3. **é‡å•ŸHome Assistant**
   ```bash
   sudo systemctl restart home-assistant@homeassistant
   ```

### æ­¥é©Ÿ2ï¼šå°å…¥Node-REDæµç¨‹

1. **æ‰“é–‹Node-REDç·¨è¼¯å™¨**
   ```
   http://æ‚¨çš„æ¨¹è“æ´¾IP:1880
   ```

2. **å°å…¥æµç¨‹**
   - é»æ“Šå³ä¸Šè§’é¸å–® â†’ å°å…¥
   - é¸æ“‡ `battery-charging-flow.json` æ–‡ä»¶
   - é»æ“Šã€Œå°å…¥ã€

3. **é…ç½®Home Assistanté€£æ¥**
   - é›™æ“Šä»»ä¸€å€‹ç¯€é»
   - é»æ“Šã€ŒServerã€æ—çš„ç·¨è¼¯æŒ‰éˆ•
   - å¡«å…¥ï¼š
     - **Base URL**: `http://localhost:8123`
     - **Access Token**: å¾HAç”¨æˆ¶è¨­å®šä¸­ç”Ÿæˆ

### æ­¥é©Ÿ3ï¼šè¼‰å…¥é…ç½®

1. **ä¸Šå‚³é…ç½®æ–‡ä»¶**
   å°‡ `battery-config.js` è¤‡è£½åˆ° Node-RED ç›®éŒ„ï¼š
   ```bash
   cp battery-config.js ~/.node-red/
   ```

2. **æ·»åŠ é…ç½®è¼‰å…¥ç¯€é»**
   åœ¨Node-REDä¸­æ·»åŠ ä»¥ä¸‹ç¯€é»ï¼š
   
   **Injectç¯€é»** â†’ **Functionç¯€é»**
   
   Functionç¯€é»ä»£ç¢¼ï¼š
   ```javascript
   // è¼‰å…¥é›»æ± å……é›»é…ç½®
   const config = require('./battery-config.js');
   global.set('batteryChargingConfig', config);
   msg.payload = "é…ç½®å·²è¼‰å…¥";
   return msg;
   ```

3. **éƒ¨ç½²ä¸¦æ¸¬è©¦**
   - é»æ“Šã€ŒDeployã€
   - é»æ“Šinjectç¯€é»æ¸¬è©¦é…ç½®è¼‰å…¥

---

## ğŸ® ç«‹å³é–‹å§‹ä½¿ç”¨

### ğŸ”‹ æ¸¬è©¦æ‰‹å‹•å……é›»

1. **é–‹å•Ÿæ’åº§**ï¼šæ‰‹å‹•é–‹å•Ÿä»»ä¸€å……é›»æ’åº§
2. **æª¢æŸ¥é€šçŸ¥**ï¼šæ‡‰è©²æ”¶åˆ°å……é›»é–‹å§‹é€šçŸ¥
3. **ç­‰å¾…è‡ªå‹•é—œé–‰**ï¼šç³»çµ±æœƒåœ¨è¨­å®šæ™‚é–“å¾Œè‡ªå‹•é—œé–‰
4. **ç¢ºèªå®Œæˆé€šçŸ¥**ï¼šæ”¶åˆ°å……é›»å®Œæˆé€šçŸ¥

### ğŸ“± æª¢æŸ¥Home Assistant

åœ¨Home Assistantä¸­æŸ¥çœ‹æ–°å¢çš„å¯¦é«”ï¼š

#### æ§åˆ¶é¢æ¿
- `input_boolean.battery_management_enabled` - ç³»çµ±ç¸½é–‹é—œ
- `input_boolean.battery_auto_maintenance` - è‡ªå‹•ç¶­è­·é–‹é—œ
- `input_boolean.battery_charging_notifications` - é€šçŸ¥é–‹é—œ

#### ç‹€æ…‹ç›£æ§
- `sensor.makita_days_since_charge` - ç‰§ç”°é›»æ± è·é›¢ä¸Šæ¬¡å……é›»å¤©æ•¸
- `sensor.eneloop_aa_days_since_charge` - ENELOOP 3è™Ÿè·é›¢ä¸Šæ¬¡å……é›»å¤©æ•¸
- `sensor.eneloop_aaa_days_since_charge` - ENELOOP 4è™Ÿè·é›¢ä¸Šæ¬¡å……é›»å¤©æ•¸

#### æ™‚é–“è¨­å®š
- `input_number.makita_charging_time` - ç‰§ç”°å……é›»æ™‚é–“
- `input_number.eneloop_aa_charging_time` - ENELOOP 3è™Ÿå……é›»æ™‚é–“
- `input_number.eneloop_aaa_charging_time` - ENELOOP 4è™Ÿå……é›»æ™‚é–“

---

## ğŸ”§ å€‹äººåŒ–è¨­å®š

### ğŸ“± é€šçŸ¥æœå‹™é…ç½®

ç·¨è¼¯ `battery-config.js` ä¸­çš„é€šçŸ¥è¨­å®šï¼š

```javascript
const notificationConfig = {
    notifyHelper: {
        enabled: true,
        service: 'notify.notify',
        targets: ['person.ming'], // æ”¹ç‚ºæ‚¨çš„personå¯¦é«”
        priority: 'normal'
    },
    synologyChat: {
        enabled: true,
        service: 'notify.synology_chat_bot_3', // æ‚¨çš„æœå‹™åç¨±
        username: 'Battery Manager',
        channel: '#smart-home'
    },
    telegram: {
        enabled: true,
        service: 'notify.telegram', // æ‚¨çš„æœå‹™åç¨±
        parseMode: 'HTML'
    }
};
```

### â° å……é›»æ™‚é–“èª¿æ•´

æ ¹æ“šæ‚¨çš„éœ€æ±‚èª¿æ•´å……é›»æ™‚é–“ï¼š

```javascript
const batteryConfig = {
    makita: {
        chargingTime: 90,        // ç‰§ç”°ï¼š90åˆ†é˜ï¼ˆå¯èª¿æ•´30-180ï¼‰
        maintenanceCycle: 30     // ç¶­è­·é€±æœŸï¼š30å¤©
    },
    eneloop_aa: {
        chargingTime: 240,       // ENELOOP 3è™Ÿï¼š240åˆ†é˜ï¼ˆå¯èª¿æ•´60-360ï¼‰
        maintenanceCycle: 60     // ç¶­è­·é€±æœŸï¼š60å¤©
    },
    eneloop_aaa: {
        chargingTime: 210,       // ENELOOP 4è™Ÿï¼š210åˆ†é˜ï¼ˆå¯èª¿æ•´60-300ï¼‰
        maintenanceCycle: 60     // ç¶­è­·é€±æœŸï¼š60å¤©
    }
};
```

### ğŸŒ™ éœéŸ³æ™‚é–“è¨­å®š

```javascript
const systemConfig = {
    quietHours: {
        enabled: true,
        start: '22:00',    // æ™šä¸Š10é»é–‹å§‹éœéŸ³
        end: '07:00'       // æ—©ä¸Š7é»çµæŸéœéŸ³
    }
};
```

---

## ğŸ“Š ä½¿ç”¨å ´æ™¯

### ğŸ”‹ æ—¥å¸¸å……é›»
1. é›»æ± ç”¨å®Œå¾Œï¼Œæ’å…¥å……é›»å™¨
2. æ‰‹å‹•é–‹å•Ÿå°æ‡‰æ’åº§
3. ç³»çµ±è‡ªå‹•ç®¡ç†å……é›»éç¨‹
4. æ”¶åˆ°å®Œæˆé€šçŸ¥å¾Œå–å‡ºé›»æ± 

### ğŸ”„ ç¶­è­·å……é›»
- ç³»çµ±æ¯æ—¥æ—©ä¸Š8é»è‡ªå‹•æª¢æŸ¥
- è¶…éç¶­è­·é€±æœŸè‡ªå‹•é–‹å•Ÿå……é›»
- ç„¡éœ€äººå·¥å¹²é 

### ğŸ›¡ï¸ å®‰å…¨ä¿è­·
- é˜²æ­¢éåº¦å……é›»æå®³é›»æ± 
- å¤šé‡é€šçŸ¥ç¢ºä¿ä¸éºæ¼
- éœéŸ³æ™‚é–“é¿å…å¤œé–“æ‰“æ“¾

---

## ğŸ†˜ å¸¸è¦‹å•é¡Œ

### â“ é€šçŸ¥æ²’æœ‰ç™¼é€ï¼Ÿ
**æª¢æŸ¥é …ç›®**ï¼š
- é€šçŸ¥æœå‹™æ˜¯å¦æ­£ç¢ºé…ç½®
- æ˜¯å¦åœ¨éœéŸ³æ™‚é–“å…§
- Home Assistanté€šçŸ¥æœå‹™æ˜¯å¦æ­£å¸¸

### â“ æ’åº§æ²’æœ‰è‡ªå‹•é—œé–‰ï¼Ÿ
**æª¢æŸ¥é …ç›®**ï¼š
- å¯¦é«”IDæ˜¯å¦æ­£ç¢º
- Home Assistanté€£æ¥æ˜¯å¦æ­£å¸¸
- è¨ˆæ™‚å™¨æ˜¯å¦æ­£å¸¸å•Ÿå‹•

### â“ ç¶­è­·å……é›»æ²’æœ‰è§¸ç™¼ï¼Ÿ
**æª¢æŸ¥é …ç›®**ï¼š
- ç³»çµ±ç¸½é–‹é—œæ˜¯å¦é–‹å•Ÿ
- è‡ªå‹•ç¶­è­·é–‹é—œæ˜¯å¦é–‹å•Ÿ
- å®šæ™‚è§¸ç™¼å™¨æ˜¯å¦æ­£å¸¸

### â“ é…ç½®æ²’æœ‰ç”Ÿæ•ˆï¼Ÿ
**æª¢æŸ¥é …ç›®**ï¼š
- é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¢ºè¼‰å…¥
- Node-REDæ˜¯å¦é‡æ–°éƒ¨ç½²
- å…¨åŸŸè®Šæ•¸æ˜¯å¦è¨­å®šæˆåŠŸ

---

## ğŸ“ æŠ€è¡“æ”¯æ´

### ğŸ” æª¢æŸ¥æ—¥èªŒ
```bash
# Home Assistant æ—¥èªŒ
tail -f /config/home-assistant.log

# Node-RED æ—¥èªŒ
journalctl -u nodered -f
```

### ğŸ”„ é‡æ–°éƒ¨ç½²
1. åœ¨Node-REDä¸­é»æ“Šã€ŒDeployã€
2. é‡æ–°è¼‰å…¥é…ç½®
3. æ¸¬è©¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸

### ğŸ†˜ ç·Šæ€¥é‡ç½®
å¦‚æœç³»çµ±å‡ºç¾å•é¡Œï¼š
1. åœç”¨æ‰€æœ‰è‡ªå‹•åŒ–
2. æ‰‹å‹•é—œé–‰æ‰€æœ‰æ’åº§
3. é‡æ–°å°å…¥æµç¨‹
4. é‡æ–°é…ç½®è¨­å®š

---

## ğŸ‰ äº«å—æ™ºèƒ½å……é›»ï¼

ç¾åœ¨æ‚¨çš„å……é›»é›»æ± ç®¡ç†ç³»çµ±å·²ç¶“æº–å‚™å°±ç·’ï¼

- âœ… å†ä¹Ÿä¸ç”¨æ“”å¿ƒéåº¦å……é›»
- âœ… è‡ªå‹•ç¶­è­·å»¶é•·é›»æ± å£½å‘½
- âœ… å¤šé‡é€šçŸ¥ç¢ºä¿ä¸éºæ¼
- âœ… å®Œå…¨è‡ªå‹•åŒ–çš„å……é›»ç®¡ç†

**é–‹å§‹äº«å—æ™ºèƒ½å®¶å±…å¸¶ä¾†çš„ä¾¿åˆ©å§ï¼** ğŸ âš¡ğŸ”‹
